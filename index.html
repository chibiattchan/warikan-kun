<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>わりかん君 Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.css">
    v13<style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
      
        body {
          font-family: 'Noto Sans JP', sans-serif;
          -webkit-tap-highlight-color: transparent;
          overscroll-behavior-y: none;
        }
      
        .no-scrollbar::-webkit-scrollbar { display: none; }
      
        /* スピン（上下矢印）は表示したいので -webkit-appearance を消さない */
      
        .inline-edit-input {
          @apply w-full bg-indigo-50 border-2 border-indigo-400 rounded px-1 font-bold text-slate-900 outline-none;
        }
      
        /* bottom-sheet 共通（非表示時は下へ、透明） */
        .bottom-sheet {
          transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.18s ease;
          transform: translateY(100%);
          opacity: 0;
          will-change: transform, opacity;
          position: fixed;
          left: 0;
          right: 0;
          z-index: 1200;
          pointer-events: none; /* 非表示時は操作を無効化 */
        }
      
        /* PC（>=640px）：中央表示（デフォルトは少し下にずらして隠す） */
        @media (min-width: 640px) {
          .bottom-sheet {
            left: 50%;
            top: 50%;
            right: auto;
            bottom: auto;
            width: min(720px, calc(100% - 48px));
            transform: translate(-50%, -60%) scale(0.98);
            opacity: 0;
            border-radius: 1.25rem;
            max-height: 90vh;
            overflow: auto;
            padding: 1.5rem;
          }
          .bottom-sheet.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
          }
        }
      
        /* スマホ（<=639px）：下からスライドアップ */
        @media (max-width: 639px) {
          .bottom-sheet {
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            border-top-left-radius: 1.25rem;
            border-top-right-radius: 1.25rem;
            max-height: 92vh;
            overflow-y: auto;
            transform: translateY(100%);
            opacity: 0;
          }
          .bottom-sheet.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
          }
        }
      
        /* モーダルのオーバーレイを確実に背面に（修正: 属性セレクタではなくクラスの組み合わせで指定） */
        #expenseModal > .absolute.inset-0,
        #memberModal > .absolute.inset-0,
        #configModal > .absolute.inset-0 {
          z-index: 1100;
        }
      </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 h-16 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-2 overflow-hidden max-w-[70%]">
            <div class="bg-indigo-600 p-2 rounded-xl shrink-0 text-white">
                <i data-lucide="calculator" size="18"></i>
            </div>
            <div class="overflow-hidden">
                <input id="projectTitle" type="text" value="新しい旅行" 
                    class="text-sm font-black bg-transparent border-none focus:ring-0 w-full truncate text-slate-800 outline-none hover:bg-slate-50 rounded px-1 transition-colors">
                <div id="projectIdDisplay" class="text-[10px] text-slate-400 px-1 uppercase tracking-tighter truncate leading-none">ID: LOADING...</div>
            </div>
        </div>
        
        <div class="flex items-center gap-1">
            <button onclick="toggleConfig()" id="syncBtn" class="p-2 rounded-xl text-slate-400 hover:bg-slate-100 hover:text-indigo-600 transition-all" title="同期設定">
                <i data-lucide="refresh-cw" size="20"></i>
            </button>
            <button onclick="copyShareUrl()" class="p-2 text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors" title="URLをコピー">
                <i data-lucide="share-2" size="20"></i>
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="flex p-2 bg-white border-b border-slate-200 sticky top-16 z-40">
        <div class="flex max-w-xl mx-auto w-full gap-2">
            <button onclick="switchTab('input')" id="tab-input" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-200">
                <i data-lucide="layout-grid" size="16"></i> 入力
            </button>
            <button onclick="switchTab('list')" id="tab-list" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all text-slate-400 hover:bg-slate-50">
                <i data-lucide="list" size="16"></i> 一覧
            </button>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4 space-y-6">
        
        <!-- Input View -->
        <div id="view-input" class="max-w-xl mx-auto space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 rounded-3xl p-5 text-white shadow-xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">合計支出</p>
                    <div id="totalAmount" class="text-2xl font-black italic tracking-tighter">¥0</div>
                </div>
                <div class="bg-white rounded-3xl p-5 border border-slate-200 shadow-sm flex flex-col justify-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">メンバー</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1">
                            <span id="memberCount" class="text-xl font-black text-slate-800">0人</span>
                            <button onclick="openMemberManager()" class="text-indigo-400 hover:text-indigo-600 p-2 transition-colors rounded-lg hover:bg-indigo-50">
                                <i data-lucide="settings" size="16"></i>
                            </button>
                        </div>
                        <button onclick="addMember(event)" class="w-10 h-10 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-all">
                            <i data-lucide="user-plus" size="20"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center justify-between px-1">
                    <h2 class="font-bold text-slate-500 text-sm">最近の支出</h2>
                    <button onclick="switchTab('list')" class="text-xs font-bold text-indigo-600 hover:underline">すべて表示</button>
                </div>
                <div id="recentExpensesList" class="space-y-3"></div>
            </div>

            <div id="result-section-input" class="space-y-4 pt-4">
                <div class="flex items-center gap-2 px-1 text-indigo-600">
                    <i data-lucide="check-circle-2" size="20"></i>
                    <h2 class="font-bold text-slate-800 text-lg">精算結果</h2>
                </div>
                <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">送金プラン</h3>
                    <div id="settlementPlan" class="space-y-3 text-center py-4 text-slate-400 text-sm italic">
                        貸し借りは現在ありません
                    </div>
                </div>
            </div>
        </div>

        <!-- List View (Full Table with Inline Editing) -->
        <div id="view-list" class="hidden space-y-8">
            <div class="space-y-4">
                <div class="flex items-center justify-between px-1">
                    <h2 class="font-black text-slate-800 text-xl tracking-tight">支出明細一覧</h2>
                    <span class="text-xs text-slate-400 font-bold bg-slate-100 px-3 py-1 rounded-full italic">セルをタップして直接編集</span>
                </div>
                <div class="bg-white rounded-3xl border border-slate-200 overflow-x-auto shadow-xl no-scrollbar">
                    <table class="w-full text-sm min-w-[800px] border-collapse">
                        <thead>
                            <tr id="fullTableHeadRow" class="bg-slate-50 border-b border-slate-100"></tr>
                        </thead>
                        <tbody id="fullExpensesTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- Individual Totals Section (Summary Table) -->
            <div class="space-y-4">
                <div class="flex items-center gap-2 px-1">
                    <i data-lucide="bar-chart-3" class="text-indigo-600" size="20"></i>
                    <h2 class="font-black text-slate-800 text-xl tracking-tight">メンバー別集計</h2>
                </div>
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-lg">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-100">
                                <th class="p-4 text-left font-black text-slate-400 text-[10px] uppercase tracking-widest">メンバー</th>
                                <th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase tracking-widest">支払済 (Paid)</th>
                                <th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase tracking-widest">負担分 (Should)</th>
                                <th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase tracking-widest">差額 (Balance)</th>
                            </tr>
                        </thead>
                        <tbody id="memberSummaryTable" class="divide-y divide-slate-50">
                            <!-- JS injected content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Floating Add Button -->
    <button id="floatingAddBtn" onclick="createNewExpense(event)" class="fixed bottom-8 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl shadow-indigo-400 flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-[60]">
        <i data-lucide="plus" size="32"></i>
    </button>

    <!-- Modal for Detailed Editing (Fallback) -->
    <div id="expenseModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
        <div class="bottom-sheet fixed inset-x-0 bottom-0 w-full bg-white rounded-t-[2.5rem] shadow-2xl p-6 max-h-[92vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-slate-800">詳細編集</h3>
                <button onclick="closeExpenseModal()" class="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-slate-200"><i data-lucide="x" size="20"></i></button>
            </div>
            <div id="modalContent" class="space-y-6 pb-10"></div>
        </div>
    </div>

    <!-- Member Manager Modal -->
    <div id="memberModal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeMemberModal()"></div>
        <div class="bottom-sheet fixed inset-x-0 bottom-0 w-full bg-white rounded-t-[2.5rem] shadow-2xl p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-slate-800">メンバー管理</h3>
                <button onclick="closeMemberModal()" class="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-slate-200"><i data-lucide="x" size="20"></i></button>
            </div>
            <div id="memberListContent" class="space-y-4 mb-6"></div>
            <button onclick="addMember(event)" class="w-full bg-indigo-50 text-indigo-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-100 transition-colors">
                <i data-lucide="user-plus" size="20"></i> メンバーを追加
            </button>
        </div>
    </div>

    <!-- Sync Settings -->
    <div id="configModal" class="fixed inset-0 z-[120] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="toggleConfig()"></div>
        <div class="relative w-full max-w-md bg-white rounded-[2rem] shadow-2xl p-8">
            <h2 class="text-2xl font-black text-slate-800 mb-2">同期設定</h2>
            <input id="gasUrlInput" type="url" placeholder="https://script.google.com/..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-4 text-sm font-bold outline-none mb-6 focus:border-indigo-500">
            <button onclick="saveConfig()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700">設定を保存</button>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
        <script>
        let state = { projectId: '', title: '新しい旅行', members: [], expenses: [] };
        let gasUrl = localStorage.getItem('fair_share_gas_url_v3') || '';
        let editingExpenseId = null;
        let autoSaveTimer = null;
        
        window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        let pid = urlParams.get('pid') || localStorage.getItem('fs_last_pid') || 'p_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('fs_last_pid', pid);
        state.projectId = pid;
        const pidEl = document.getElementById('projectIdDisplay');
        if (pidEl) pidEl.innerText = `ID: ${pid}`;
        const gasInput = document.getElementById('gasUrlInput');
        if (gasInput) gasInput.value = gasUrl;
        
        const cached = localStorage.getItem('fs_cache_' + pid);
        if (cached) try { state = JSON.parse(cached); } catch (e) {}
        
        // Project title change handler
        const titleInput = document.getElementById('projectTitle');
        if (titleInput) {
            titleInput.value = state.title || '新しい旅行';
            titleInput.addEventListener('input', (e) => {
            state.title = e.target.value;
            triggerAutoSave();
            });
        }
        
        // Global: select all text when input (text/number) receives focus
        document.addEventListener('focusin', (ev) => {
            const t = ev.target;
            if (!t) return;
            if (t.tagName === 'INPUT' && (t.type === 'text' || t.type === 'number')) {
            // next tick helps on mobile to avoid caret jump
            setTimeout(() => { try { t.select(); } catch (e) {} }, 0);
            }
        });
        
        render();
        if (gasUrl) fetchData().catch(()=>{});
        };
        
        function formatCurrency(n) { return '¥' + Math.round(n).toLocaleString(); }
        // ページ上で onclick="switchTab('input')" のように呼ばれるのでグローバルで定義する
        function switchTab(t) {
        const viewInput = document.getElementById('view-input');
        const viewList  = document.getElementById('view-list');
        if (viewInput) viewInput.classList.toggle('hidden', t !== 'input');
        if (viewList)  viewList.classList.toggle('hidden', t !== 'list');

        const bI = document.getElementById('tab-input');
        const bL = document.getElementById('tab-list');
        const active = "flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-200";
        const inactive = "flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all text-slate-400 hover:bg-slate-50";
        if (bI) bI.className = t === 'input' ? active : inactive;
        if (bL) bL.className = t === 'list' ? active : inactive;

        // keep UI in sync
        if (typeof render === 'function') render();
        }
        function escapeHtml(s) { return s ? s.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }
        
        function calculate() {
        const balances = {};
        state.members.forEach(m => balances[m.id] = { paid: 0, should: 0, diff: 0 });
        
        let total = 0;
        state.expenses.forEach(exp => {
            const amt = parseFloat(exp.amount) || 0;
            total += amt;
            if (balances[exp.payerId]) balances[exp.payerId].paid += amt;
        
            let totalWeight = 0;
            state.members.forEach(m => totalWeight += (parseFloat(exp.weights?.[m.id]) || 0));
            if (totalWeight > 0) {
            const perWeight = amt / totalWeight;
            state.members.forEach(m => {
                const w = parseFloat(exp.weights?.[m.id]) || 0;
                balances[m.id].should += w * perWeight;
            });
            }
        });
        
        Object.keys(balances).forEach(id => balances[id].diff = balances[id].paid - balances[id].should);
        
        const d = [], c = [];
        Object.entries(balances).forEach(([id,b]) => {
            const name = (state.members.find(m => m.id === id) || {}).name || '不明';
            if (b.diff < -0.1) d.push({ id, amt: b.diff, name });
            else if (b.diff > 0.1) c.push({ id, amt: b.diff, name });
        });
        
        const plan = [];
        let i = 0, j = 0;
        const dCopy = JSON.parse(JSON.stringify(d));
        const cCopy = JSON.parse(JSON.stringify(c));
        while (i < dCopy.length && j < cCopy.length) {
            const s = Math.min(Math.abs(dCopy[i].amt), cCopy[j].amt);
            if (s > 0.1) plan.push({ fromName: dCopy[i].name, toName: cCopy[j].name, amount: s });
            dCopy[i].amt += s;
            cCopy[j].amt -= s;
            if (Math.abs(dCopy[i].amt) < 0.1) i++;
            if (cCopy[j].amt < 0.1) j++;
        }
        
        return { total, plan, balances };
        }
        
        function render() {
        const calculation = calculate();
        const totalEl = document.getElementById('totalAmount');
        if (totalEl) totalEl.innerText = formatCurrency(calculation.total);
        const memberCountEl = document.getElementById('memberCount');
        if (memberCountEl) memberCountEl.innerText = `${state.members.length}人`;
        
        // Recent
        const recentContainer = document.getElementById('recentExpensesList');
        if (recentContainer) {
            recentContainer.innerHTML = '';
            if (state.members.length === 0) {
            recentContainer.innerHTML = `<div class="bg-white rounded-3xl p-10 border-2 border-dashed border-slate-200 text-center text-slate-400 font-bold">メンバーを追加してください</div>`;
            } else {
            state.expenses.slice(0,5).forEach(exp => {
                const payer = (state.members.find(m => m.id === exp.payerId) || {}).name || '削除済';
                const div = document.createElement('div');
                div.className = "w-full bg-white p-4 rounded-2xl border border-slate-200 flex items-center justify-between shadow-sm cursor-pointer active:scale-95 transition-all";
                div.onclick = () => openExpenseModal(exp.id);
                div.innerHTML = `<div class="overflow-hidden pr-2"><div class="font-bold text-slate-800 truncate">${escapeHtml(exp.title || '無題')}</div><div class="text-[10px] text-slate-400 mt-1 font-black uppercase tracking-widest"><span class="text-indigo-500">${escapeHtml(payer)}</span> 支払</div></div><div class="text-lg font-black italic text-slate-800">${formatCurrency(exp.amount)}</div>`;
                recentContainer.appendChild(div);
            });
            }
        }
        
        // Full table
        const headRow = document.getElementById('fullTableHeadRow');
        const tableBody = document.getElementById('fullExpensesTable');
        if (headRow && tableBody) {
            headRow.innerHTML = `
            <th class="p-4 text-left font-black text-slate-400 text-[10px] uppercase tracking-widest w-48">項目</th>
            <th class="p-4 text-left font-black text-slate-400 text-[10px] uppercase tracking-widest w-32">支払者</th>
            <th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase tracking-widest w-32">金額</th>
            ${state.members.map(m => `<th class="p-4 text-center font-black text-slate-400 text-[10px] uppercase tracking-widest border-l border-slate-100 min-w-[70px]">${escapeHtml(m.name)}<br>(Weight)</th>`).join('')}
            <th class="p-4 text-center font-black text-slate-400 text-[10px] w-12"></th>
            `;
            tableBody.innerHTML = '';
            state.expenses.forEach(exp => {
            const tr = document.createElement('tr');
            tr.className = "group hover:bg-slate-50 transition-colors";
            const tdTitle = createEditableTd(exp.title || '無題', (val) => updateExpData(exp.id, 'title', val), 'text');
            const tdPayer = createSelectTd(exp.payerId, state.members, (v) => updateExpData(exp.id, 'payerId', v));
            const tdAmount = createEditableTd(exp.amount, (val) => updateExpData(exp.id, 'amount', val), 'number', true);
            tr.appendChild(tdTitle);
            tr.appendChild(tdPayer);
            tr.appendChild(tdAmount);
            state.members.forEach(m => {
                const weight = exp.weights?.[m.id] || 0;
                const tdWeight = createEditableTd(weight, (val) => {
                exp.weights = exp.weights || {};
                exp.weights[m.id] = Math.max(0, parseFloat(val) || 0);
                render();
                triggerAutoSave();
                }, 'number');
                tdWeight.className = `p-2 text-center border-l border-slate-50 font-black text-xs ${weight > 0 ? 'text-indigo-600 bg-indigo-50/30' : 'text-slate-300'}`;
                tr.appendChild(tdWeight);
            });
            const tdAction = document.createElement('td');
            tdAction.className = "p-2 text-center";
            tdAction.innerHTML = `<button onclick="deleteExpense('${exp.id}')" class="text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" size="14"></i></button>`;
            tr.appendChild(tdAction);
            tableBody.appendChild(tr);
            });
        }
        
        // Member summary
        const summaryBody = document.getElementById('memberSummaryTable');
        if (summaryBody) {
            summaryBody.innerHTML = '';
            state.members.forEach(m => {
            const b = calculation.balances[m.id] || { paid: 0, should: 0, diff: 0 };
            const balanceColor = b.diff > 0.1 ? 'text-indigo-600' : (b.diff < -0.1 ? 'text-rose-500' : 'text-slate-400');
            const balanceIcon = b.diff > 0.1 ? '+' : '';
            const tr = document.createElement('tr');
            tr.className = "font-bold text-slate-700";
            tr.innerHTML = `
                <td class="p-4 font-black text-slate-800">${escapeHtml(m.name)}</td>
                <td class="p-4 text-right">${formatCurrency(b.paid)}</td>
                <td class="p-4 text-right text-slate-400 font-medium">${formatCurrency(b.should)}</td>
                <td class="p-4 text-right font-black italic text-lg ${balanceColor}">${balanceIcon}${formatCurrency(b.diff)}</td>
            `;
            summaryBody.appendChild(tr);
            });
        }
        
        // Settlement plan
        const planContainer = document.getElementById('settlementPlan');
        if (planContainer) {
            planContainer.innerHTML = '';
            if (calculation.plan.length === 0) planContainer.innerHTML = '貸し借りは現在ありません';
            else calculation.plan.forEach(p => {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100";
            div.innerHTML = `<div class="text-left"><span class="text-[9px] block text-rose-400 font-bold uppercase mb-1">支払う</span><span class="font-bold">${escapeHtml(p.fromName)}</span></div><div class="text-right font-black">${formatCurrency(p.amount)} → ${escapeHtml(p.toName)}</div>`;
            planContainer.appendChild(div);
            });
        }
        
        try { localStorage.setItem('fs_cache_' + state.projectId, JSON.stringify(state)); } catch (e) {}
        if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
        }
        
        /* Inline editing helpers */
        function createEditableTd(value, onSave, type = 'text', isCurrency = false) {
        const td = document.createElement('td');
        td.className = "p-4 cursor-pointer hover:bg-indigo-50/50 transition-all font-bold text-slate-700";
        if (type === 'number' && !isCurrency) td.className += " text-right";
        if (isCurrency) td.className += " text-right font-black italic text-slate-800";
        
        const displayValue = isCurrency ? formatCurrency(value) : value;
        td.innerText = displayValue;
        
        td.onclick = (e) => {
            if (td.querySelector('input')) return;
            const input = document.createElement('input');
            // choose input type
            input.type = (type === 'number' || isCurrency) ? 'number' : 'text';
            input.value = value;
            input.className = "inline-edit-input";
            input.inputMode = (input.type === 'number') ? 'numeric' : input.inputMode;
        
            // step settings
            if (isCurrency) input.step = "1000";
            else if (type === 'number') input.step = "0.1";
        
            // ensure native spin controls available
            input.style.webkitAppearance = 'auto';
            input.style.appearance = 'auto';
        
            if (isCurrency || type === 'number') input.className += " text-right";
        
            td.innerText = '';
            td.appendChild(input);
        
            // select-all on focus
            input.onfocus = () => { try { input.select(); } catch (e) {} };
            input.focus();
        
            const save = () => {
            const newVal = input.value;
            try { td.removeChild(input); } catch (e) {}
            onSave(newVal);
            };
        
            input.onblur = save;
            input.onkeydown = (ev) => { if (ev.key === 'Enter') save(); };
        };
        return td;
        }
        
        function createSelectTd(currentId, options, onSave) {
        const td = document.createElement('td');
        td.className = "p-4 cursor-pointer hover:bg-indigo-50/50 transition-all font-bold text-indigo-600";
        const payer = options.find(o => o.id === currentId)?.name || '未選択';
        td.innerText = payer;
        
        td.onclick = () => {
            if (td.querySelector('select')) return;
            const select = document.createElement('select');
            select.className = "inline-edit-input py-0";
            options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt.id;
            o.innerText = opt.name;
            o.selected = opt.id === currentId;
            select.appendChild(o);
            });
        
            td.innerText = '';
            td.appendChild(select);
            select.focus();
        
            const save = () => {
            const newVal = select.value;
            try { td.removeChild(select); } catch (e) {}
            onSave(newVal);
            };
        
            select.onblur = save;
            select.onchange = save;
        };
        return td;
        }
        
        /* CRUD & Modals */
        function createNewExpense(e) {
        if (e && e.preventDefault) e.preventDefault();
        if (state.members.length === 0) { addMember(e); return; }
        const id = 'e_' + Math.random().toString(36).substr(2, 9);
        const weights = {}; state.members.forEach(m => weights[m.id] = 1);
        state.expenses.unshift({ id, title: '', amount: 0, payerId: state.members[0].id, weights });
        render();
        openExpenseModal(id);
        }
        
        function deleteExpense(id) {
        if (!confirm('この支出を削除しますか？')) return;
        state.expenses = state.expenses.filter(e => e.id !== id);
        render();
        triggerAutoSave();
        }
        
        /* Expense modal with Weight UI */
        function openExpenseModal(id) {
        const exp = state.expenses.find(e => e.id === id);
        if (!exp) return;
        const content = document.getElementById('modalContent');
        
        content.innerHTML = `
            <div class="space-y-6">
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">項目名</label>
                <input id="modal_title" type="text" value="${escapeHtml(exp.title || '')}" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 text-sm font-bold outline-none" />
            </div>
        
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">金額</label>
                <input id="modal_amount" type="number" inputmode="numeric" min="0" step="1000" value="${Number(exp.amount || 0)}" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 text-sm font-black text-right outline-none" />
            </div>
        
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">支払者</label>
                <select id="modal_payer" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 text-sm font-bold outline-none">
                ${state.members.map(m => `<option value="${m.id}" ${m.id === exp.payerId ? 'selected' : ''}>${escapeHtml(m.name)}</option>`).join('')}
                </select>
            </div>
        
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">分配（Weight）</label>
                <div id="modal_weights" class="space-y-2">
                ${state.members.map(m => {
                    const val = Number(exp.weights?.[m.id] ?? 0);
                    const onClass = val >= 0.95 ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600';
                    const offClass = val <= 0.05 ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600';
                    return `
                    <div class="flex items-center justify-between gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="font-bold text-slate-800">${escapeHtml(m.name)}</div>
                        <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                            <button type="button" class="weight-toggle-off px-3 py-1 rounded-full ${offClass}" data-memberid="${m.id}" aria-pressed="${val <= 0.05}">OFF</button>
                            <button type="button" class="weight-toggle-on px-3 py-1 rounded-full ${onClass}" data-memberid="${m.id}" aria-pressed="${val >= 0.95}">ON</button>
                        </div>
                        <div class="flex items-center gap-1 bg-white rounded-md p-1 border border-slate-100">
                            <button type="button" class="weight-dec px-2 py-1 rounded text-slate-600 bg-slate-100" data-memberid="${m.id}">−</button>
                            <input data-memberid="${m.id}" class="weight-input w-20 text-right bg-transparent outline-none text-sm font-bold" type="number" step="0.1" min="0" value="${val.toFixed(1)}" />
                            <button type="button" class="weight-inc px-2 py-1 rounded text-slate-600 bg-slate-100" data-memberid="${m.id}">+</button>
                        </div>
                        </div>
                    </div>
                    `;
                }).join('')}
                </div>
            </div>
        
            <div class="flex gap-3">
                <button id="modal_save" class="flex-1 bg-indigo-600 text-white py-3 rounded-2xl font-bold">保存</button>
                <button id="modal_cancel" class="flex-1 bg-slate-100 py-3 rounded-2xl font-bold">キャンセル</button>
            </div>
            </div>
        `;
        
        const mEl = document.getElementById('expenseModal');
        if (!mEl) return;
        mEl.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        const sheet = mEl.querySelector('.bottom-sheet');
        if (sheet) { sheet.classList.remove('active'); setTimeout(() => sheet.classList.add('active'), 20); }
        
        // weight helpers
        function refreshWeightControls(memberId, value) {
            const input = document.querySelector(`#modal_weights input.weight-input[data-memberid="${memberId}"]`);
            if (input) input.value = value.toFixed(1);
            const onBtn = document.querySelector(`#modal_weights .weight-toggle-on[data-memberid="${memberId}"]`);
            const offBtn = document.querySelector(`#modal_weights .weight-toggle-off[data-memberid="${memberId}"]`);
            if (onBtn) {
            if (value >= 0.95) { onBtn.classList.add('bg-indigo-600','text-white'); onBtn.classList.remove('bg-slate-100','text-slate-600'); onBtn.setAttribute('aria-pressed','true'); }
            else { onBtn.classList.remove('bg-indigo-600','text-white'); onBtn.classList.add('bg-slate-100','text-slate-600'); onBtn.setAttribute('aria-pressed','false'); }
            }
            if (offBtn) {
            if (value <= 0.05) { offBtn.classList.add('bg-indigo-600','text-white'); offBtn.classList.remove('bg-slate-100','text-slate-600'); offBtn.setAttribute('aria-pressed','true'); }
            else { offBtn.classList.remove('bg-indigo-600','text-white'); offBtn.classList.add('bg-slate-100','text-slate-600'); offBtn.setAttribute('aria-pressed','false'); }
            }
        }
        
        function setWeightAndRefresh(memberId, rawValue) {
            const v = Math.round(Math.max(0, rawValue) * 10) / 10;
            exp.weights = exp.weights || {};
            exp.weights[memberId] = v;
        
            triggerAutoSave();
            refreshWeightControls(memberId, v);
        
            // minimal dashboard updates
            const calc = calculate();
            const totalEl = document.getElementById('totalAmount');
            if (totalEl) totalEl.innerText = formatCurrency(calc.total);
        
            const summaryBody = document.getElementById('memberSummaryTable');
            if (summaryBody) {
            summaryBody.innerHTML = '';
            state.members.forEach(m => {
                const b = calc.balances[m.id] || { paid: 0, should: 0, diff: 0 };
                const balanceColor = b.diff > 0.1 ? 'text-indigo-600' : (b.diff < -0.1 ? 'text-rose-500' : 'text-slate-400');
                const balanceIcon = b.diff > 0.1 ? '+' : '';
                const tr = document.createElement('tr');
                tr.className = "font-bold text-slate-700";
                tr.innerHTML = `
                <td class="p-4 font-black text-slate-800">${escapeHtml(m.name)}</td>
                <td class="p-4 text-right">${formatCurrency(b.paid)}</td>
                <td class="p-4 text-right text-slate-400 font-medium">${formatCurrency(b.should)}</td>
                <td class="p-4 text-right font-black italic text-lg ${balanceColor}">${balanceIcon}${formatCurrency(b.diff)}</td>
                `;
                summaryBody.appendChild(tr);
            });
            }
        
            const planContainer = document.getElementById('settlementPlan');
            if (planContainer) {
            planContainer.innerHTML = '';
            if (calc.plan.length === 0) planContainer.innerHTML = '貸し借りは現在ありません';
            else calc.plan.forEach(p => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100";
                div.innerHTML = `<div class="text-left"><span class="text-[9px] block text-rose-400 font-bold uppercase mb-1">支払う</span><span class="font-bold">${escapeHtml(p.fromName)}</span></div><div class="text-right font-black">${formatCurrency(p.amount)} → ${escapeHtml(p.toName)}</div>`;
                planContainer.appendChild(div);
            });
            }
        }
        
        // attach event listeners
        document.querySelectorAll('#modal_weights .weight-toggle-on').forEach(btn => btn.addEventListener('click', () => setWeightAndRefresh(btn.dataset.memberid, 1)));
        document.querySelectorAll('#modal_weights .weight-toggle-off').forEach(btn => btn.addEventListener('click', () => setWeightAndRefresh(btn.dataset.memberid, 0)));
        document.querySelectorAll('#modal_weights .weight-inc').forEach(btn => btn.addEventListener('click', () => {
            const mid = btn.dataset.memberid;
            const cur = parseFloat(document.querySelector(`#modal_weights input.weight-input[data-memberid="${mid}"]`).value) || 0;
            setWeightAndRefresh(mid, cur + 0.1);
        }));
        document.querySelectorAll('#modal_weights .weight-dec').forEach(btn => btn.addEventListener('click', () => {
            const mid = btn.dataset.memberid;
            const cur = parseFloat(document.querySelector(`#modal_weights input.weight-input[data-memberid="${mid}"]`).value) || 0;
            setWeightAndRefresh(mid, Math.max(0, cur - 0.1));
        }));
        document.querySelectorAll('#modal_weights input.weight-input').forEach(inp => {
            inp.addEventListener('input', () => {
            const mid = inp.dataset.memberid;
            let val = parseFloat(inp.value); if (isNaN(val)) val = 0;
            setWeightAndRefresh(mid, val);
            });
            inp.addEventListener('blur', () => {
            const mid = inp.dataset.memberid;
            const v = parseFloat(inp.value);
            setWeightAndRefresh(mid, isNaN(v) ? 0 : v);
            });
        });
        
        // save/cancel
        const saveBtn = document.getElementById('modal_save');
        if (saveBtn) saveBtn.onclick = () => {
            const title = (document.getElementById('modal_title') || {}).value || '';
            const amount = parseFloat((document.getElementById('modal_amount') || {}).value) || 0;
            const payerId = (document.getElementById('modal_payer') || {}).value || exp.payerId;
            exp.title = title.trim();
            exp.amount = amount;
            exp.payerId = payerId;
            render();
            triggerAutoSave();
            closeExpenseModal();
        };
        const cancelBtn = document.getElementById('modal_cancel');
        if (cancelBtn) cancelBtn.onclick = () => closeExpenseModal();
        
        // sync initial toggle states
        state.members.forEach(m => {
            const v = Number(exp.weights?.[m.id] ?? 0);
            refreshWeightControls(m.id, v);
        });
        
        setTimeout(() => {
            const t = document.getElementById('modal_title');
            if (t) t.focus();
        }, 60);
        
        if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
        }
        
        function closeExpenseModal() {
        const m = document.getElementById('expenseModal');
        if (!m) return;
        m.querySelector('.bottom-sheet')?.classList.remove('active');
        setTimeout(() => {
            document.body.style.overflow = '';
            m.classList.add('hidden');
        }, 300);
        }
        
        /* Members */
        function addMember(e) {
        if (e && e.preventDefault) e.preventDefault();
        const name = prompt('名前：');
        if (!name || !name.trim()) return;
        const id = 'm_' + Math.random().toString(36).substr(2, 5);
        state.members.push({ id, name: name.trim() });
        state.expenses.forEach(exp => { if (!exp.weights) exp.weights = {}; if (exp.weights[id] === undefined) exp.weights[id] = 1; });
        render();
        triggerAutoSave();
        }
        
        function openMemberManager() {
        const content = document.getElementById('memberListContent');
        if (!content) return;
        content.innerHTML = state.members.length === 0 ? '<p class="text-center py-10 text-slate-400 italic">なし</p>' : '';
        state.members.forEach(m => {
            const div = document.createElement('div'); div.className = "flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100";
            div.innerHTML = `<span class="font-bold text-slate-800">${escapeHtml(m.name)}</span><div class="flex items-center gap-2"><button onclick="deleteMember('${m.id}')" class="p-2 text-slate-400 hover:text-rose-500 bg-white rounded-xl shadow-sm border border-slate-200"><i data-lucide="trash-2" size="16"></i></button></div>`;
            content.appendChild(div);
        });
        const modal = document.getElementById('memberModal'); modal.classList.remove('hidden');
        setTimeout(() => modal.querySelector('.bottom-sheet').classList.add('active'), 10);
        lucide.createIcons();
        }
        
        function deleteMember(id) {
        if (!confirm('メンバーを削除しますか？（過去の記録にも影響します）')) return;
        state.members = state.members.filter(m => m.id !== id);
        state.expenses.forEach(exp => { if (exp.weights) delete exp.weights[id]; });
        render();
        triggerAutoSave();
        openMemberManager();
        }
        
        function closeMemberModal() {
        const m = document.getElementById('memberModal');
        if (!m) return;
        m.querySelector('.bottom-sheet')?.classList.remove('active');
        setTimeout(() => m.classList.add('hidden'), 300);
        }
        
        /* Sync / Helpers */
        function triggerAutoSave() {
        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => saveToCloud(), 2000);
        }
        
        async function fetchData() {
        if (!gasUrl) return;
        setSyncing(true);
        try {
            const r = await fetch(`${gasUrl}?action=get&projectId=${state.projectId}`);
            const j = await r.json();
            if (j.ok && j.data) { state = j.data; render(); }
        } catch(e) {}
        setSyncing(false);
        }
        
        async function saveToCloud() {
        if (!gasUrl) return;
        setSyncing(true);
        try {
            await fetch(gasUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'save', projectId: state.projectId, payload: state, projectName: state.title }) });
        } catch(e) {}
        setSyncing(false);
        }
        
        function setSyncing(s) { const b = document.getElementById('syncBtn'); if (!b) return; const i = b.querySelector('i'); if (!i) return; if (s) i.classList.add('animate-spin'); else i.classList.remove('animate-spin'); }
        
        function copyShareUrl() {
        const u = new URL(window.location.href);
        u.searchParams.set('pid', state.projectId);
        const t = document.createElement("input"); document.body.appendChild(t); t.value = u.toString(); t.select(); document.execCommand("copy"); document.body.removeChild(t); alert("共有用URLをコピーしました！");
        }
        </script>

</body>
</html>