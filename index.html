<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„ªç§€ã‚ã‚Šã‹ã‚“å›</title>
    all<script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .inline-edit-input { @apply w-full bg-indigo-50 border-2 border-indigo-400 rounded px-1 font-bold text-slate-900 outline-none; }
        .bottom-sheet {
            transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.18s ease;
            transform: translateY(100%); opacity: 0;
            position: fixed; left: 0; right: 0; z-index: 1200; pointer-events: none;
        }
        @media (min-width: 640px) {
            .bottom-sheet { left: 50%; top: 50%; width: min(720px, calc(100% - 48px)); transform: translate(-50%, -60%) scale(0.98); border-radius: 1.25rem; max-height: 90vh; overflow: auto; padding: 1.5rem; }
            .bottom-sheet.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        }
        @media (max-width: 639px) {
            .bottom-sheet { left: 0; right: 0; bottom: 0; border-top-left-radius: 1.25rem; border-top-right-radius: 1.25rem; max-height: 92vh; overflow-y: auto; }
            .bottom-sheet.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 h-16 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-2 overflow-hidden max-w-[70%]">
            <div class="bg-indigo-600 p-2 rounded-xl shrink-0 text-white"><i data-lucide="calculator" size="18"></i></div>
            <div class="overflow-hidden">
                <input id="projectTitle" type="text" value="æ–°ã—ã„æ—…è¡Œ" class="text-sm font-black bg-transparent border-none focus:ring-0 w-full truncate text-slate-800 outline-none hover:bg-slate-50 rounded px-1 transition-colors">
                <div id="projectIdDisplay" class="text-[10px] text-slate-400 px-1 uppercase tracking-tighter truncate leading-none">ID: LOADING...</div>
            </div>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="toggleConfig()" id="syncBtn" class="p-2 rounded-xl text-slate-400 hover:bg-slate-100 transition-all"><i data-lucide="refresh-cw" size="20"></i></button>
            <button onclick="copyShareUrl()" class="p-2 text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors"><i data-lucide="share-2" size="20"></i></button>
        </div>
    </header>

    <div class="flex p-2 bg-white border-b border-slate-200 sticky top-16 z-40">
        <div class="flex max-w-xl mx-auto w-full gap-2">
            <button onclick="switchTab('input')" id="tab-input" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-200">å…¥åŠ›</button>
            <button onclick="switchTab('list')" id="tab-list" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all text-slate-400 hover:bg-slate-50">ä¸€è¦§</button>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4 space-y-6">
        <div id="view-input" class="max-w-xl mx-auto space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 rounded-3xl p-5 text-white shadow-xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">åˆè¨ˆæ”¯å‡º</p>
                    <div id="totalAmount" class="text-2xl font-black italic tracking-tighter">Â¥0</div>
                </div>
                <div class="bg-white rounded-3xl p-5 border border-slate-200 shadow-sm flex flex-col justify-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ãƒ¡ãƒ³ãƒãƒ¼</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1">
                            <span id="memberCount" class="text-xl font-black text-slate-800">0äºº</span>
                            <button onclick="openMemberManager()" class="text-indigo-400 p-2"><i data-lucide="settings" size="16"></i></button>
                        </div>
                        <button onclick="addMember(event)" class="w-10 h-10 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="user-plus" size="20"></i></button>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center justify-between px-1"><h2 class="font-bold text-slate-500 text-sm">æœ€è¿‘ã®æ”¯å‡º</h2></div>
                <div id="recentExpensesList" class="space-y-3"></div>
            </div>

            <div id="result-section-input" class="space-y-4 pt-4">
                <div class="flex items-center gap-2 px-1 text-indigo-600"><i data-lucide="check-circle-2" size="20"></i><h2 class="font-bold text-slate-800 text-lg">ç²¾ç®—çµæœ</h2></div>
                <div id="settlementPlan" class="text-center py-4 text-slate-400 text-sm italic">è²¸ã—å€Ÿã‚Šã¯ç¾åœ¨ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>

        <div id="view-list" class="hidden space-y-8">
            <div class="bg-white rounded-3xl border border-slate-200 overflow-x-auto shadow-xl no-scrollbar">
                <table class="w-full text-sm min-w-[800px] border-collapse">
                    <thead><tr id="fullTableHeadRow" class="bg-slate-50 border-b border-slate-100"></tr></thead>
                    <tbody id="fullExpensesTable" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
            <div id="memberSummaryTableContainer" class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-lg">
                <table class="w-full text-sm border-collapse">
                    <thead><tr class="bg-slate-50 border-b border-slate-100"><th class="p-4 text-left font-black text-slate-400 text-[10px] uppercase">ãƒ¡ãƒ³ãƒãƒ¼</th><th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase">æ”¯æ‰•æ¸ˆ</th><th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase">è² æ‹…åˆ†</th><th class="p-4 text-right font-black text-slate-400 text-[10px] uppercase">å·®é¡</th></tr></thead>
                    <tbody id="memberSummaryTable" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </main>

    <button id="floatingAddBtn" onclick="createNewExpense(event)" class="fixed bottom-8 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center z-[60] active:scale-95 transition-all"><i data-lucide="plus" size="32"></i></button>

    <div id="expenseModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
        <div class="bottom-sheet fixed inset-x-0 bottom-0 w-full bg-white p-6 max-h-[92vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black text-slate-800">è©³ç´°ç·¨é›†</h3><button onclick="closeExpenseModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" size="20"></i></button></div>
            <div id="modalContent" class="space-y-6 pb-10"></div>
        </div>
    </div>

    <div id="memberModal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeMemberModal()"></div>
        <div class="bottom-sheet fixed inset-x-0 bottom-0 w-full bg-white p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black text-slate-800">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h3><button onclick="closeMemberModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" size="20"></i></button></div>
            <div id="memberListContent" class="space-y-4 mb-6"></div>
            <button onclick="addMember(event)" class="w-full bg-indigo-50 text-indigo-600 py-4 rounded-2xl font-bold">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </button>
        </div>
    </div>

    <div id="configModal" class="fixed inset-0 z-[120] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="toggleConfig()"></div>
        <div class="relative w-full max-w-md bg-white rounded-[2rem] p-8">
            <h2 class="text-2xl font-black text-slate-800 mb-2">åŒæœŸè¨­å®š</h2>
            <input id="gasUrlInput" type="url" placeholder="GAS URL" class="w-full bg-slate-50 border-2 rounded-2xl px-4 py-4 mb-6">
            <button onclick="saveConfig()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let state = { projectId: '', title: 'æ–°ã—ã„æ—…è¡Œ', members: [], expenses: [] };
        let gasUrl = localStorage.getItem('fair_share_gas_url_v3') || '';
        let autoSaveTimer = null;

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            let pid = urlParams.get('pid') || localStorage.getItem('fs_last_pid') || 'p_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('fs_last_pid', pid);
            state.projectId = pid;
            document.getElementById('projectIdDisplay').innerText = `ID: ${pid}`;
            const cached = localStorage.getItem('fs_cache_' + pid);
            if (cached) try { state = JSON.parse(cached); } catch (e) {}
            document.getElementById('projectTitle').value = state.title || 'æ–°ã—ã„æ—…è¡Œ';
            document.getElementById('projectTitle').addEventListener('input', (e) => { state.title = e.target.value; triggerAutoSave(); });
            render();
            if (gasUrl) fetchData();
        };

        function formatCurrency(n) { return 'Â¥' + Math.round(n).toLocaleString(); }
        function escapeHtml(s) { return s ? s.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }

        function renderSettlementPlan(calculation) {
            const planContainer = document.getElementById('settlementPlan');
            if (!planContainer) return;
            planContainer.innerHTML = '';
            if (!calculation || !calculation.plan || calculation.plan.length === 0) {
                planContainer.innerHTML = `<div class="bg-indigo-50 border-2 border-indigo-200 rounded-3xl p-6 text-center font-black text-indigo-600">ç²¾ç®—ã¯ä¸è¦ã§ã™âœ¨</div>`;
                return;
            }
            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';
            calculation.plan.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-indigo-50 border-2 border-indigo-200 rounded-3xl p-4 flex items-center justify-between gap-4';
                card.innerHTML = `
                    <div class="flex-1 min-w-0"><div class="text-[9px] font-black text-slate-400 uppercase">æ”¯æ‰•ã†</div><div class="font-black text-slate-900 truncate">${escapeHtml(p.fromName)}</div></div>
                    <div class="flex items-center gap-2"><i data-lucide="arrow-right" class="text-indigo-600" size="16"></i><div class="text-xl font-black text-slate-900">${formatCurrency(p.amount)}</div></div>
                    <div class="flex-1 text-right min-w-0"><div class="text-[9px] font-black text-slate-400 uppercase">å—å–ã‚‹</div><div class="font-black text-slate-900 truncate">${escapeHtml(p.toName)}</div></div>
                `;
                wrapper.appendChild(card);
            });
            planContainer.appendChild(wrapper);
            if (window.lucide) lucide.createIcons();
        }

        function calculate() {
            const balances = {};
            state.members.forEach(m => balances[m.id] = { paid: 0, should: 0, diff: 0 });
            let total = 0;
            state.expenses.forEach(exp => {
                const amt = parseFloat(exp.amount) || 0;
                total += amt;
                if (balances[exp.payerId]) balances[exp.payerId].paid += amt;
                let totalWeight = 0;
                state.members.forEach(m => totalWeight += (parseFloat(exp.weights?.[m.id]) || 0));
                if (totalWeight > 0) {
                    const perWeight = amt / totalWeight;
                    state.members.forEach(m => { balances[m.id].should += (parseFloat(exp.weights?.[m.id]) || 0) * perWeight; });
                }
            });
            Object.keys(balances).forEach(id => balances[id].diff = balances[id].paid - balances[id].should);
            const plan = [], d = [], c = [];
            Object.entries(balances).forEach(([id,b]) => {
                const name = (state.members.find(m => m.id === id) || {}).name || 'ä¸æ˜';
                if (b.diff < -0.1) d.push({ name, amt: b.diff });
                else if (b.diff > 0.1) c.push({ name, amt: b.diff });
            });
            let i=0, j=0;
            while(i<d.length && j<c.length) {
                const s = Math.min(Math.abs(d[i].amt), c[j].amt);
                plan.push({ fromName: d[i].name, toName: c[j].name, amount: s });
                d[i].amt += s; c[j].amt -= s;
                if (Math.abs(d[i].amt) < 0.1) i++;
                if (c[j].amt < 0.1) j++;
            }
            return { total, plan, balances };
        }

        function render() {
            const calc = calculate();
            document.getElementById('totalAmount').innerText = formatCurrency(calc.total);
            document.getElementById('memberCount').innerText = `${state.members.length}äºº`;
            
            const recent = document.getElementById('recentExpensesList');
            recent.innerHTML = '';
            state.expenses.slice(0,5).forEach(exp => {
                const pName = (state.members.find(m => m.id === exp.payerId) || {}).name || '-';
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-200 flex justify-between cursor-pointer active:scale-95 transition-all";
                div.onclick = () => openExpenseModal(exp.id);
                div.innerHTML = `<div><div class="font-bold text-slate-800">${escapeHtml(exp.title || 'ç„¡é¡Œ')}</div><div class="text-[10px] text-slate-400 font-black">${escapeHtml(pName)} æ”¯æ‰•</div></div><div class="text-lg font-black italic">${formatCurrency(exp.amount)}</div>`;
                recent.appendChild(div);
            });

            const tableBody = document.getElementById('fullExpensesTable');
            const headRow = document.getElementById('fullTableHeadRow');
            if (tableBody && headRow) {
                headRow.innerHTML = `<th class="p-4 text-left">é …ç›®</th><th class="p-4 text-left">æ”¯æ‰•è€…</th><th class="p-4 text-right">é‡‘é¡</th>${state.members.map(m => `<th class="p-4 text-center">${escapeHtml(m.name)}</th>`).join('')}<th></th>`;
                tableBody.innerHTML = '';
                state.expenses.forEach(exp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="p-4 font-bold">${escapeHtml(exp.title)}</td><td class="p-4 text-indigo-600 font-bold">${escapeHtml(state.members.find(m=>m.id===exp.payerId)?.name)}</td><td class="p-4 text-right font-black">${formatCurrency(exp.amount)}</td>${state.members.map(m => `<td class="p-4 text-center ${exp.weights?.[m.id]>0?'bg-indigo-50 text-indigo-600 font-black':'text-slate-200'}">${exp.weights?.[m.id]>0?'âœ”':''}</td>`).join('')}<td class="p-4"><button onclick="deleteExpense('${exp.id}')" class="text-slate-300">ğŸ—‘</button></td>`;
                    tr.onclick = () => openExpenseModal(exp.id);
                    tableBody.appendChild(tr);
                });
            }

            const summaryBody = document.getElementById('memberSummaryTable');
            summaryBody.innerHTML = state.members.map(m => {
                const b = calc.balances[m.id];
                return `<tr class="font-bold"><td class="p-4 font-black">${escapeHtml(m.name)}</td><td class="p-4 text-right">${formatCurrency(b.paid)}</td><td class="p-4 text-right text-slate-400">${formatCurrency(b.should)}</td><td class="p-4 text-right font-black ${b.diff>0?'text-indigo-600':'text-rose-500'}">${b.diff>0?'+':''}${formatCurrency(b.diff)}</td></tr>`;
            }).join('');

            renderSettlementPlan(calc);
            localStorage.setItem('fs_cache_' + state.projectId, JSON.stringify(state));
            if (window.lucide) lucide.createIcons();
        }

        function openExpenseModal(id) {
            const exp = state.expenses.find(e => e.id === id);
            if (!exp) return;
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <div><label class="text-[10px] font-black text-slate-400 block mb-2 uppercase">é …ç›®å</label><input id="modal_title" type="text" value="${escapeHtml(exp.title)}" class="w-full bg-slate-50 border-2 rounded-2xl px-4 py-3 font-bold outline-none"></div>
                    <div><label class="text-[10px] font-black text-slate-400 block mb-2 uppercase">é‡‘é¡</label><input id="modal_amount" type="number" value="${exp.amount}" class="w-full bg-slate-50 border-2 rounded-2xl px-4 py-3 font-black text-right outline-none"></div>
                    <div><label class="text-[10px] font-black text-slate-400 block mb-2 uppercase">æ”¯æ‰•è€…</label><select id="modal_payer" class="w-full bg-slate-50 border-2 rounded-2xl px-4 py-3 font-bold">${state.members.map(m=>`<option value="${m.id}" ${m.id===exp.payerId?'selected':''}>${escapeHtml(m.name)}</option>`).join('')}</select></div>
                    <div><label class="text-[10px] font-black text-slate-400 block mb-4 uppercase tracking-widest">è² æ‹…ã™ã‚‹äºº</label><div class="grid grid-cols-2 gap-3">${state.members.map(m => `<button onclick="toggleWeight('${exp.id}','${m.id}')" class="py-3 px-4 rounded-2xl font-bold border-2 ${exp.weights?.[m.id]>0?'bg-indigo-600 border-indigo-600 text-white shadow-lg':'bg-white border-slate-100 text-slate-400'}">${escapeHtml(m.name)}</button>`).join('')}</div></div>
                    <button onclick="deleteExpense('${exp.id}');closeExpenseModal();" class="w-full py-4 text-rose-500 font-bold">ã“ã®æ”¯å‡ºã‚’å‰Šé™¤</button>
                </div>
            `;
            const updateAll = () => { exp.title = document.getElementById('modal_title').value; exp.amount = parseFloat(document.getElementById('modal_amount').value) || 0; exp.payerId = document.getElementById('modal_payer').value; render(); triggerAutoSave(); };
            document.getElementById('modal_title').oninput = updateAll;
            document.getElementById('modal_amount').oninput = updateAll;
            document.getElementById('modal_payer').onchange = updateAll;

            const modal = document.getElementById('expenseModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('.bottom-sheet').classList.add('active'), 10);
        }

        function toggleWeight(expId, mId) { const exp = state.expenses.find(e=>e.id===expId); exp.weights[mId] = exp.weights[mId] > 0 ? 0 : 1; render(); openExpenseModal(expId); triggerAutoSave(); }
        function closeExpenseModal() { const sheet = document.getElementById('expenseModal').querySelector('.bottom-sheet'); sheet.classList.remove('active'); setTimeout(() => document.getElementById('expenseModal').classList.add('hidden'), 300); }
        function switchTab(t) { document.getElementById('view-input').classList.toggle('hidden', t!=='input'); document.getElementById('view-list').classList.toggle('hidden', t!=='list'); const bI=document.getElementById('tab-input'), bL=document.getElementById('tab-list'), active="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all bg-indigo-600 text-white shadow-lg", inactive="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all text-slate-400 hover:bg-slate-50"; bI.className = t==='input'?active:inactive; bL.className = t==='list'?active:inactive; }
        function createNewExpense(e) { if(state.members.length===0) return addMember(e); const id='e_'+Math.random().toString(36).substr(2,9), weights={}; state.members.forEach(m=>weights[m.id]=1); state.expenses.unshift({id, title:'', amount:0, payerId:state.members[0].id, weights}); render(); openExpenseModal(id); }
        function deleteExpense(id) { if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; state.expenses = state.expenses.filter(e=>e.id!==id); render(); triggerAutoSave(); }
        function openMemberManager() { renderMemberList(); const m=document.getElementById('memberModal'); m.classList.remove('hidden'); setTimeout(()=>m.querySelector('.bottom-sheet').classList.add('active'),10); }
        function closeMemberModal() { const s=document.getElementById('memberModal').querySelector('.bottom-sheet'); s.classList.remove('active'); setTimeout(()=>document.getElementById('memberModal').classList.add('hidden'),300); }
        function renderMemberList() { document.getElementById('memberListContent').innerHTML = state.members.map(m=>`<div class="flex items-center gap-3 bg-slate-50 p-3 rounded-2xl"><input type="text" value="${escapeHtml(m.name)}" onchange="updateMemberName('${m.id}',this.value)" class="flex-1 bg-transparent border-none font-bold outline-none"><button onclick="removeMember('${m.id}')" class="text-slate-300">ğŸ—‘</button></div>`).join(''); if(window.lucide) lucide.createIcons(); }
        function addMember(e) { const id='m_'+Math.random().toString(36).substr(2,9); state.members.push({id, name:'æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼'}); render(); openMemberManager(); triggerAutoSave(); }
        function updateMemberName(id,n) { const m=state.members.find(m=>m.id===id); if(m) m.name=n; render(); triggerAutoSave(); }
        function removeMember(id) { state.members=state.members.filter(m=>m.id!==id); render(); renderMemberList(); triggerAutoSave(); }
        function toggleConfig() { document.getElementById('configModal').classList.toggle('hidden'); }
        function saveConfig() { gasUrl=document.getElementById('gasUrlInput').value; localStorage.setItem('fair_share_gas_url_v3', gasUrl); toggleConfig(); }
        function triggerAutoSave() { if(autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer=setTimeout(()=>{ if(gasUrl) syncData(); },2000); }
        async function fetchData() { try { const res=await fetch(`${gasUrl}?pid=${state.projectId}`); const data=await res.json(); if(data.members){ state=data; render(); } } catch(e){} }
        async function syncData() { try { await fetch(gasUrl, {method:'POST', body:JSON.stringify(state)}); } catch(e){} }
        function copyShareUrl() { const url = window.location.origin + window.location.pathname + '?pid=' + state.projectId; navigator.clipboard.writeText(url).then(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')); }
    </script>
</body>
</html>