<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>わりかん君 Pro - 共有できる精算ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'sans-serif', 'Apple Color Emoji'; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-12">

    <!-- ナビゲーションバー -->
    <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-200">
                    <i data-lucide="calculator" class="w-5 h-5 text-white"></i>
                </div>
                <span class="font-bold text-lg hidden sm:block bg-clip-text text-transparent bg-gradient-to-r from-indigo-700 to-indigo-500">わりかん君 Pro</span>
            </div>

            <div class="flex-1 max-w-sm relative group">
                <i data-lucide="type" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                <input id="projectTitle" type="text" placeholder="無題の精算" class="w-full bg-slate-100/50 border-none focus:ring-2 focus:ring-indigo-100 rounded-xl pl-9 pr-4 py-2 text-sm font-semibold transition-all outline-none">
            </div>

            <div class="flex items-center gap-2">
                <button onclick="toggleHistory()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl border border-slate-200 transition-all">
                    <i data-lucide="history" class="w-5 h-5"></i>
                </button>
                <button onclick="copyShareLink()" id="copyBtn" class="flex items-center bg-white text-slate-700 border border-slate-200 px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-slate-50 transition-all active:scale-95 shadow-sm">
                    <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                    <span class="hidden sm:inline" id="copyBtnText">URLをコピー</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 履歴ドロワー -->
    <div id="historyDrawer" class="fixed inset-0 z-50 flex justify-end hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="toggleHistory()"></div>
        <div class="relative w-full max-w-sm bg-white h-full shadow-2xl p-6 overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="history" class="text-indigo-600"></i> 履歴</h2>
                <button onclick="toggleHistory()" class="p-2 text-slate-400 hover:bg-slate-100 rounded-lg"><i data-lucide="x"></i></button>
            </div>
            <div id="historyList" class="space-y-4">
                <!-- 履歴がここに挿入される -->
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
        <!-- サマリーカード -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-6 bg-indigo-600 text-white rounded-2xl relative overflow-hidden shadow-lg shadow-indigo-200">
                <div class="relative z-10">
                    <p class="text-indigo-100 text-xs font-bold uppercase tracking-wider mb-1">合計支出</p>
                    <h3 id="totalSpentDisplay" class="text-3xl font-black">¥0</h3>
                </div>
                <i data-lucide="dollar-sign" class="absolute -right-4 -bottom-4 w-24 h-24 text-white/10 rotate-12"></i>
            </div>
            
            <div class="md:col-span-2 flex flex-wrap items-center gap-3" id="memberList">
                <!-- メンバーリストがここに挿入される -->
                <div class="flex items-center gap-2 bg-slate-200/50 rounded-2xl px-3 py-1.5 focus-within:bg-white focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                    <input id="newMemberInput" placeholder="名前..." class="bg-transparent border-none focus:ring-0 text-sm font-medium w-24 outline-none">
                    <button onclick="addMember()" class="text-indigo-600 hover:scale-110 transition-transform"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

        <!-- 支出入力セクション -->
        <section class="space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="dollar-sign" class="text-indigo-500"></i> 支出データ</h2>
                <button onclick="addExpense()" class="flex items-center bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-medium hover:bg-indigo-700 transition-all shadow-md shadow-indigo-200 active:scale-95">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i> 支出を追加
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold text-[10px] uppercase">
                                <th class="p-4 w-12 text-center"></th>
                                <th class="p-4 min-w-[180px]">内容</th>
                                <th class="p-4 w-[140px] text-right">金額</th>
                                <th class="p-4 w-[160px]">支払人</th>
                                <th id="memberHeaderContainer" class="p-0">
                                    <!-- メンバー名ヘッダーが動的に入る -->
                                </th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody" class="divide-y divide-slate-100">
                            <!-- 支出行がここに挿入される -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 精算結果 -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="pie-chart" class="text-slate-400"></i> 個人別の収支</h3>
                <div id="balanceList" class="space-y-3">
                    <!-- 収支リスト -->
                </div>
            </div>

            <div class="bg-slate-900 p-6 rounded-2xl shadow-xl text-white">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-400"><i data-lucide="check-circle" class="w-5 h-5"></i> 精算プラン</h3>
                <div id="settlementPlan" class="space-y-3">
                    <!-- 精算プラン -->
                </div>
                <p class="mt-6 text-[10px] text-slate-500 text-center">※送金回数が最小になるよう最適化されています</p>
            </div>
        </section>
    </main>

    <script>
        // --- State ---
        let state = {
            title: '',
            members: [
                { id: 'm1', name: 'ユーザーA' },
                { id: 'm2', name: 'ユーザーB' }
            ],
            expenses: [
                { id: 'e1', title: '昼食', amount: 2000, payerId: 'm1', weights: { 'm1': 1, 'm2': 1 } }
            ]
        };

        const STORAGE_KEY = 'fair_share_history_v2';

        // --- Utilities ---
        const encodeState = (data) => {
            const jsonString = JSON.stringify(data);
            const base64 = btoa(encodeURIComponent(jsonString));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        };

        const decodeState = (hash) => {
            try {
                if (!hash || !hash.startsWith('#s=')) return null;
                let base64 = hash.substring(3).replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) base64 += '=';
                return JSON.parse(decodeURIComponent(atob(base64)));
            } catch (e) { return null; }
        };

        const formatCurrency = (val) => `¥${Math.round(val).toLocaleString()}`;

        // --- Core Logic ---
        function calculate() {
            const balances = {};
            state.members.forEach(m => balances[m.id] = 0);
            let totalSpent = 0;

            state.expenses.forEach(exp => {
                const amount = parseFloat(exp.amount) || 0;
                totalSpent += amount;
                if (balances[exp.payerId] !== undefined) balances[exp.payerId] += amount;

                let totalWeight = 0;
                state.members.forEach(m => totalWeight += (exp.weights[m.id] || 0));

                if (totalWeight > 0) {
                    const costPerWeight = amount / totalWeight;
                    state.members.forEach(m => {
                        balances[m.id] -= (exp.weights[m.id] || 0) * costPerWeight;
                    });
                }
            });

            const debtors = [], creditors = [];
            Object.entries(balances).forEach(([id, amt]) => {
                if (amt < -0.01) debtors.push({ id, amt });
                else if (amt > 0.01) creditors.push({ id, amt });
            });

            debtors.sort((a, b) => a.amt - b.amt);
            creditors.sort((a, b) => b.amt - a.amt);

            const plan = [];
            let i = 0, j = 0;
            const d = JSON.parse(JSON.stringify(debtors));
            const c = JSON.parse(JSON.stringify(creditors));

            while (i < d.length && j < c.length) {
                const settleAmt = Math.min(Math.abs(d[i].amt), c[j].amt);
                plan.push({
                    from: state.members.find(m => m.id === d[i].id).name,
                    to: state.members.find(m => m.id === c[j].id).name,
                    amount: settleAmt
                });
                d[i].amt += settleAmt;
                c[j].amt -= settleAmt;
                if (Math.abs(d[i].amt) < 0.01) i++;
                if (c[j].amt < 0.01) j++;
            }

            render(totalSpent, balances, plan);
        }

        // --- Render Functions ---
        function render(totalSpent, balances, plan) {
            document.getElementById('totalSpentDisplay').innerText = formatCurrency(totalSpent);
            
            // Render Members (Summary Area)
            const mList = document.getElementById('memberList');
            const newMemberInputNode = mList.lastElementChild;
            mList.innerHTML = '';
            state.members.forEach(m => {
                const div = document.createElement('div');
                div.className = "bg-white px-4 py-2 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-3 group animate-in";
                div.innerHTML = `
                    <div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-[10px] font-black flex items-center justify-center border border-indigo-200">${m.name.charAt(0)}</div>
                    <span class="text-sm font-bold text-slate-700">${m.name}</span>
                    <button onclick="deleteMember('${m.id}')" class="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button>
                `;
                mList.appendChild(div);
            });
            mList.appendChild(newMemberInputNode);

            // Render Header for Table
            const hContainer = document.getElementById('memberHeaderContainer');
            hContainer.innerHTML = '';
            state.members.forEach(m => {
                const th = document.createElement('th');
                th.className = "p-4 text-center border-l border-slate-100 min-w-[80px]";
                th.innerHTML = `<div class="truncate w-16 mx-auto">${m.name}</div>`;
                hContainer.appendChild(th);
            });

            // Render Expense Rows
            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = '';
            state.expenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50/20 transition-colors group";
                
                let weightCells = '';
                state.members.forEach(m => {
                    const isActive = (exp.weights[m.id] || 0) > 0;
                    weightCells += `
                        <td class="p-2 border-l border-slate-50 transition-colors ${isActive ? 'bg-indigo-50/30' : ''}">
                            <div class="flex justify-center">
                                <button onclick="toggleWeight('${exp.id}', '${m.id}')" class="w-10 h-10 rounded-2xl flex items-center justify-center transition-all ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-300 hover:bg-slate-200'}">
                                    <i data-lucide="${isActive ? 'check' : 'x'}" class="${isActive ? 'w-5 h-5' : 'w-4 h-4'}"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });

                tr.innerHTML = `
                    <td class="p-4 text-center">
                        <button onclick="deleteExpense('${exp.id}')" class="text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                    <td class="p-2">
                        <input onchange="updateExpense('${exp.id}', 'title', this.value)" value="${exp.title}" placeholder="ランチなど" class="w-full bg-transparent border-none focus:ring-2 focus:ring-indigo-100 rounded-lg font-medium">
                    </td>
                    <td class="p-2">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">¥</span>
                            <input type="number" onchange="updateExpense('${exp.id}', 'amount', this.value)" value="${exp.amount || ''}" class="w-full pl-7 pr-3 py-2 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-100 font-black text-right outline-none">
                        </div>
                    </td>
                    <td class="p-2">
                        <select onchange="updateExpense('${exp.id}', 'payerId', this.value)" class="w-full bg-transparent border-none focus:ring-2 focus:ring-indigo-100 rounded-lg text-sm font-bold cursor-pointer">
                            ${state.members.map(m => `<option value="${m.id}" ${m.id === exp.payerId ? 'selected' : ''}>${m.name}</option>`).join('')}
                        </select>
                    </td>
                    ${weightCells}
                `;
                tbody.appendChild(tr);
            });

            // Render Individual Balances
            const bList = document.getElementById('balanceList');
            bList.innerHTML = '';
            state.members.forEach(m => {
                const bal = balances[m.id] || 0;
                const isPos = bal > 0.01;
                const isNeg = bal < -0.01;
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-4 rounded-2xl bg-slate-50 border border-slate-100";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-slate-500 font-bold text-xs border border-slate-200 shadow-sm">${m.name.charAt(0)}</div>
                        <span class="font-bold text-slate-700">${m.name}</span>
                    </div>
                    <div class="font-black ${isPos ? 'text-emerald-600' : isNeg ? 'text-rose-500' : 'text-slate-400'}">
                        ${isPos ? '+' : ''}${formatCurrency(bal)}
                    </div>
                `;
                bList.appendChild(div);
            });

            // Render Plan
            const pDiv = document.getElementById('settlementPlan');
            pDiv.innerHTML = '';
            if (plan.length === 0) {
                pDiv.innerHTML = `<div class="py-10 text-center text-slate-500 italic">すべての貸し借りが清算されています！</div>`;
            } else {
                plan.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-white/5 p-4 rounded-xl border border-white/5";
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-rose-400">${p.from}</span>
                            <i data-lucide="arrow-right" class="w-3 h-3 text-slate-600"></i>
                            <span class="font-bold text-emerald-400">${p.to}</span>
                        </div>
                        <div class="text-xl font-black">${formatCurrency(p.amount)}</div>
                    `;
                    pDiv.appendChild(div);
                });
            }

            lucide.createIcons();
        }

        // --- Actions ---
        function addMember() {
            const input = document.getElementById('newMemberInput');
            const name = input.value.trim();
            if (!name) return;
            const id = 'm' + Date.now();
            state.members.push({ id, name });
            state.expenses.forEach(e => e.weights[id] = 1);
            input.value = '';
            calculate();
        }

        function deleteMember(id) {
            if (state.members.length <= 1) return;
            state.members = state.members.filter(m => m.id !== id);
            state.expenses.forEach(e => {
                delete e.weights[id];
                if (e.payerId === id) e.payerId = state.members[0].id;
            });
            calculate();
        }

        function addExpense() {
            const id = 'e' + Date.now();
            const weights = {};
            state.members.forEach(m => weights[m.id] = 1);
            state.expenses.push({ id, title: '', amount: 0, payerId: state.members[0].id, weights });
            calculate();
        }

        function updateExpense(id, field, value) {
            const exp = state.expenses.find(e => e.id === id);
            if (exp) {
                exp[field] = field === 'amount' ? parseFloat(value) : value;
                calculate();
            }
        }

        function toggleWeight(eid, mid) {
            const exp = state.expenses.find(e => e.id === eid);
            if (exp) {
                exp.weights[mid] = exp.weights[mid] === 0 ? 1 : 0;
                calculate();
            }
        }

        function deleteExpense(id) {
            state.expenses = state.expenses.filter(e => e.id !== id);
            calculate();
        }

        function toggleHistory() {
            const drawer = document.getElementById('historyDrawer');
            drawer.classList.toggle('hidden');
            if (!drawer.classList.contains('hidden')) renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            list.innerHTML = history.length ? '' : '<p class="text-center text-slate-400 py-10">履歴はありません</p>';
            history.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-2xl border border-slate-100 hover:border-indigo-200 hover:bg-indigo-50/50 transition-all";
                btn.onclick = () => { window.location.href = item.url; location.reload(); };
                btn.innerHTML = `
                    <div class="font-bold text-slate-800 truncate mb-1">${item.title}</div>
                    <div class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${new Date(item.createdAt).toLocaleString()}</div>
                `;
                list.appendChild(btn);
            });
            lucide.createIcons();
        }

        function copyShareLink() {
            const hash = 's=' + encodeState(state);
            const url = window.location.origin + window.location.pathname + '#' + hash;
            
            // Clipboard copy
            const el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            // Update History
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const newEntry = {
                id: Date.now(),
                title: state.title || '無題の精算',
                url: url,
                createdAt: new Date().toISOString()
            };
            const updated = [newEntry, ...history.filter(h => h.url !== url)].slice(0, 10);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));

            // UI Feedback
            const btnText = document.getElementById('copyBtnText');
            const btn = document.getElementById('copyBtn');
            const oldText = btnText.innerText;
            btnText.innerText = 'コピーしました！';
            btn.classList.replace('text-slate-700', 'text-indigo-600');
            setTimeout(() => {
                btnText.innerText = oldText;
                btn.classList.replace('text-indigo-600', 'text-slate-700');
            }, 2000);
        }

        // --- Init ---
        window.onload = () => {
            const saved = decodeState(window.location.hash);
            if (saved) state = saved;
            
            const titleInput = document.getElementById('projectTitle');
            titleInput.value = state.title;
            titleInput.oninput = (e) => state.title = e.target.value;

            calculate();
        };

        window.onhashchange = () => {
            const saved = decodeState(window.location.hash);
            if (saved) {
                state = saved;
                document.getElementById('projectTitle').value = state.title;
                calculate();
            }
        };
    </script>
</body>
</html>