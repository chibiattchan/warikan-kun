<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>優秀わりかん君</title>
    resultupdate<script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .bottom-sheet {
            transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.18s ease;
            transform: translateY(100%); opacity: 0;
            position: fixed; left: 0; right: 0; z-index: 1200; pointer-events: none;
        }
        @media (min-width: 640px) {
            .bottom-sheet { 
                left: 50%; top: 50%; 
                width: min(720px, calc(100% - 48px)); 
                transform: translate(-50%, -60%) scale(0.98); 
                border-radius: 2rem; 
                max-height: 85vh; 
                overflow-y: auto; 
                padding: 2rem; 
            }
            .bottom-sheet.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        }
        @media (max-width: 639px) {
            .bottom-sheet { left: 0; right: 0; bottom: 0; border-top-left-radius: 2rem; border-top-right-radius: 2rem; max-height: 92vh; overflow-y: auto; }
            .bottom-sheet.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32">

    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-4 sticky top-0 z-[60] shadow-lg">
        <div class="flex items-baseline gap-3">
            <span class="font-black text-xl tracking-tight">みんわり</span>
            <span class="text-xs opacity-90 font-medium">ゴチャゴチャしても、最後はきれいに！</span>
        </div>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-[52px] z-50 px-4 h-16 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-2 overflow-hidden max-w-[70%]">
            <div class="bg-indigo-600 p-2 rounded-xl shrink-0 text-white"><i data-lucide="users" size="18"></i></div>
            <div class="overflow-hidden">
                <input id="projectTitle" type="text" value="新しい旅行" class="text-sm font-black bg-transparent border-none focus:ring-0 w-full truncate text-slate-800 outline-none hover:bg-slate-50 rounded px-1 transition-colors">
                <div id="projectIdDisplay" class="text-[10px] text-slate-400 px-1 uppercase tracking-tighter truncate leading-none">ID: LOADING...</div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="createNewProject()" class="flex items-center gap-1 px-3 py-2 text-emerald-600 bg-emerald-50 rounded-xl hover:bg-emerald-100 transition-colors text-sm font-bold" title="新規プロジェクト">
                <i data-lucide="plus-circle" size="18"></i>
                <span class="hidden sm:inline">新規作成</span>
            </button>
            <button onclick="copyShareUrl()" class="flex items-center gap-1 px-3 py-2 text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors text-sm font-bold" title="共有">
                <i data-lucide="share-2" size="18"></i>
                <span class="hidden sm:inline">共有URLコピー</span>
            </button>
        </div>
    </header>

    <div class="flex p-2 bg-white border-b border-slate-200 sticky top-[116px] z-40">
        <div class="flex max-w-xl mx-auto w-full gap-2">
            <button onclick="switchTab('input')" id="tab-input" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-200">入力</button>
            <button onclick="switchTab('list')" id="tab-list" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all text-slate-400 hover:bg-slate-50">一覧</button>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4 space-y-6">
        <div id="view-input" class="max-w-xl mx-auto space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 rounded-3xl p-5 text-white shadow-xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">合計支出</p>
                    <div id="totalAmount" class="text-2xl font-black italic tracking-tighter">¥0</div>
                </div>
                <div class="bg-white rounded-3xl p-5 border border-slate-200 shadow-sm flex flex-col justify-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">メンバー</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1">
                            <span id="memberCount" class="text-xl font-black text-slate-800">0人</span>
                        </div>
                        <button onclick="openMemberManager()" class="w-10 h-10 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100"><i data-lucide="users" size="20"></i></button>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center justify-between px-1"><h2 class="font-bold text-slate-500 text-sm">最近の支出</h2></div>
                <div id="recentExpensesList" class="space-y-3"></div>
            </div>

            <div id="result-section-input" class="space-y-4 pt-4">
                <div class="flex items-center gap-2 px-1 text-indigo-600"><i data-lucide="check-circle-2" size="20"></i><h2 class="font-bold text-slate-800 text-lg">精算結果</h2></div>
                <div id="settlementPlan" class="text-center py-4 text-slate-400 text-sm italic">貸し借りは現在ありません</div>
            </div>
        </div>

        <div id="view-list" class="hidden space-y-8">
            <div class="bg-white rounded-3xl border border-slate-200 overflow-x-auto shadow-xl no-scrollbar">
                <table class="w-full text-sm min-w-[800px] border-collapse">
                    <thead><tr id="fullTableHeadRow" class="bg-slate-50 border-b border-slate-100 text-left"></tr></thead>
                    <tbody id="fullExpensesTable" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
            <div id="memberSummaryTableContainer" class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-lg">
                <table class="w-full text-sm border-collapse text-left">
                    <thead><tr class="bg-slate-50 border-b border-slate-100 font-black text-slate-400 text-[10px] uppercase"><th class="p-4">メンバー</th><th class="p-4 text-right">支払済</th><th class="p-4 text-right">負担分</th><th class="p-4 text-right">差額</th></tr></thead>
                    <tbody id="memberSummaryTable" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </main>

    <button id="floatingAddBtn" onclick="createNewExpense(event)" class="fixed bottom-8 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center z-[60] active:scale-95 transition-all hover:bg-indigo-700"><i data-lucide="plus" size="32"></i></button>

    <div id="expenseModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
        <div class="bottom-sheet fixed inset-x-0 bottom-0 w-full bg-white p-6 max-h-[92vh] overflow-y-auto no-scrollbar shadow-2xl">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black text-slate-800">支出の編集</h3><button onclick="closeExpenseModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" size="20"></i></button></div>
            <div id="modalContent" class="space-y-6 pb-10"></div>
        </div>
    </div>

    <div id="memberModal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeMemberModal()"></div>
        <div class="bottom-sheet fixed inset-x-0 bottom-0 w-full bg-white p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black text-slate-800">メンバー管理</h3><button onclick="closeMemberModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" size="20"></i></button></div>
            <div id="memberListContent" class="space-y-4 mb-6"></div>
            <button onclick="addMember(event)" class="w-full bg-indigo-50 text-indigo-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-2"><i data-lucide="user-plus" size="20"></i> メンバーを追加</button>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let state = { projectId: '', title: '新しい旅行', members: [], expenses: [] };
        // GASのURLをハードコード
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyjeHBCKw-w57HoWlqm67eZztKAjYHb0TyVyl7H0jPfrCqBx-i2xiyTTKwhdZBLabca-Q/exec';
        let autoSaveTimer = null;

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            let pid = urlParams.get('pid') || localStorage.getItem('fs_last_pid') || 'p_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('fs_last_pid', pid);
            state.projectId = pid;
            document.getElementById('projectIdDisplay').innerText = `ID: ${pid}`;
            const cached = localStorage.getItem('fs_cache_' + pid);
            if (cached) try { state = JSON.parse(cached); } catch (e) {}
            document.getElementById('projectTitle').value = state.title || '新しい旅行';
            document.getElementById('projectTitle').oninput = (e) => { state.title = e.target.value; triggerAutoSave(); };
            render();
            fetchData();
        };

        function formatCurrency(n) { return '¥' + Math.round(n).toLocaleString(); }
        function escapeHtml(s) { return s ? s.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }

        function calculate() {
            const balances = {};
            state.members.forEach(m => balances[m.id] = { paid: 0, should: 0, diff: 0 });
            let total = 0;
            state.expenses.forEach(exp => {
                const amt = parseFloat(exp.amount) || 0;
                total += amt;
                if (balances[exp.payerId]) balances[exp.payerId].paid += amt;
                let totalWeight = 0;
                state.members.forEach(m => totalWeight += (parseFloat(exp.weights?.[m.id]) || 0));
                if (totalWeight > 0) {
                    const perWeight = amt / totalWeight;
                    state.members.forEach(m => { balances[m.id].should += (parseFloat(exp.weights?.[m.id]) || 0) * perWeight; });
                }
            });
            Object.keys(balances).forEach(id => balances[id].diff = balances[id].paid - balances[id].should);
            const plan = [], d = [], c = [];
            Object.entries(balances).forEach(([id,b]) => {
                const name = (state.members.find(m => m.id === id) || {}).name || '不明';
                if (b.diff < -0.1) d.push({ name, amt: b.diff });
                else if (b.diff > 0.1) c.push({ name, amt: b.diff });
            });
            let i=0, j=0;
            while(i<d.length && j<c.length) {
                const s = Math.min(Math.abs(d[i].amt), c[j].amt);
                plan.push({ fromName: d[i].name, toName: c[j].name, amount: s });
                d[i].amt += s; c[j].amt -= s;
                if (Math.abs(d[i].amt) < 0.1) i++;
                if (c[j].amt < 0.1) j++;
            }
            return { total, plan, balances };
        }

        function render() {
            const calc = calculate();
            document.getElementById('totalAmount').innerText = formatCurrency(calc.total);
            document.getElementById('memberCount').innerText = `${state.members.length}人`;
            
            const recent = document.getElementById('recentExpensesList');
            recent.innerHTML = '';
            state.expenses.slice(0,5).forEach(exp => {
                const pName = (state.members.find(m => m.id === exp.payerId) || {}).name || '-';
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-200 flex justify-between cursor-pointer active:scale-95 transition-all shadow-sm";
                div.onclick = () => openExpenseModal(exp.id);
                div.innerHTML = `<div><div class="font-bold text-slate-800">${escapeHtml(exp.title || '無題')}</div><div class="text-[10px] text-slate-400 font-black">${escapeHtml(pName)} 支払</div></div><div class="text-lg font-black italic">${formatCurrency(exp.amount)}</div>`;
                recent.appendChild(div);
            });

            const tableBody = document.getElementById('fullExpensesTable');
            const headRow = document.getElementById('fullTableHeadRow');
            if (tableBody && headRow) {
                headRow.innerHTML = `<th class="p-4">項目</th><th class="p-4">支払者</th><th class="p-4 text-right">金額</th>${state.members.map(m => `<th class="p-4 text-center">${escapeHtml(m.name)}</th>`).join('')}<th></th>`;
                tableBody.innerHTML = '';
                state.expenses.forEach(exp => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors cursor-pointer";
                    tr.innerHTML = `<td class="p-4 font-bold" onclick="openExpenseModal('${exp.id}')">${escapeHtml(exp.title)}</td><td class="p-4 text-indigo-600 font-bold" onclick="openExpenseModal('${exp.id}')">${escapeHtml(state.members.find(m=>m.id===exp.payerId)?.name)}</td><td class="p-4 text-right font-black" onclick="openExpenseModal('${exp.id}')">${formatCurrency(exp.amount)}</td>${state.members.map(m => `<td class="p-4 text-center ${exp.weights?.[m.id]>0?'bg-indigo-50 text-indigo-600 font-black':'text-slate-200'}" onclick="toggleWeightInTable('${exp.id}','${m.id}')">${exp.weights?.[m.id]>0? (exp.weights[m.id] > 1 ? exp.weights[m.id] : '✔') :''}</td>`).join('')}<td class="p-4 text-right"><button onclick="deleteExpense('${exp.id}')" class="text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" size="16"></i></button></td>`;
                    tableBody.appendChild(tr);
                });
            }

            const summaryBody = document.getElementById('memberSummaryTable');
            summaryBody.innerHTML = state.members.map(m => {
                const b = calc.balances[m.id];
                return `<tr class="font-bold"><td class="p-4 font-black">${escapeHtml(m.name)}</td><td class="p-4 text-right">${formatCurrency(b.paid)}</td><td class="p-4 text-right text-slate-400">${formatCurrency(b.should)}</td><td class="p-4 text-right font-black ${b.diff>0?'text-indigo-600':'text-rose-500'}">${b.diff>0?'+':''}${formatCurrency(b.diff)}</td></tr>`;
            }).join('');

            const planContainer = document.getElementById('settlementPlan');
            if (calc.plan.length === 0) {
                planContainer.innerHTML = state.members.map(m => `
                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-3xl p-4 mb-3 flex items-center justify-between gap-4">
                        <div class="flex-1 min-w-0 text-left">
                            <div class="text-[9px] font-black text-slate-400 uppercase">メンバー</div>
                            <div class="font-black text-slate-900 truncate">${escapeHtml(m.name)}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-base font-black text-slate-400">精算なし</div>
                        </div>
                    </div>
                `).join('');
            } else {
                planContainer.innerHTML = calc.plan.map(p => `
                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-3xl p-4 mb-3 flex items-center justify-between gap-4">
                        <div class="flex-1 min-w-0 text-left">
                            <div class="text-[9px] font-black text-rose-400 uppercase">支払う</div>
                            <div class="font-black text-rose-600 truncate">${escapeHtml(p.fromName)}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="arrow-right" size="16" class="text-slate-400"></i>
                            <div class="text-xl font-black text-slate-900">${formatCurrency(p.amount)}</div>
                        </div>
                        <div class="flex-1 text-right min-w-0">
                            <div class="text-[9px] font-black text-emerald-400 uppercase">受取る</div>
                            <div class="font-black text-emerald-600 truncate">${escapeHtml(p.toName)}</div>
                        </div>
                    </div>
                `).join('');
            }

            localStorage.setItem('fs_cache_' + state.projectId, JSON.stringify(state));
            if (window.lucide) lucide.createIcons();
        }

        function openExpenseModal(id) {
            const exp = state.expenses.find(e => e.id === id);
            if (!exp) return;
            const content = document.getElementById('modalContent');
            
            // モーダルのヘッダーを元に戻す（×ボタンのみ）
            const modalHeader = document.querySelector('#expenseModal h3').parentElement;
            modalHeader.innerHTML = `
                <h3 class="text-xl font-black text-slate-800">支出の編集</h3>
                <button onclick="closeExpenseModal()" class="p-2 bg-slate-100 rounded-full">
                    <i data-lucide="x" size="20"></i>
                </button>
            `;

            content.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase">項目名</label>
                        <input id="modal_title" type="text" value="${escapeHtml(exp.title)}" placeholder="例：タクシー代" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase">支払者</label>
                        <select id="modal_payer" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none focus:border-indigo-500 transition-colors">
                            ${state.members.map(m => `<option value="${m.id}" ${exp.payerId === m.id ? 'selected' : ''}>${escapeHtml(m.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase">金額</label>
                        <div class="flex gap-2 mb-3">
                            <button onclick="addAmount('${exp.id}', 1000)" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold text-xs hover:bg-indigo-100">+1,000</button>
                            <button onclick="addAmount('${exp.id}', 5000)" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold text-xs hover:bg-indigo-100">+5,000</button>
                            <button onclick="addAmount('${exp.id}', 10000)" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold text-xs hover:bg-indigo-100">+10,000</button>
                        </div>
                        <input id="modal_amount" type="number" inputmode="numeric" value="${exp.amount}" onclick="this.select()" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-black text-right text-xl outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-4 uppercase tracking-widest">負担する人（Weight）</label>
                        <div class="grid grid-cols-2 gap-3">
                            ${state.members.map(m => `
                                <div class="flex flex-col gap-1">
                                    <button onclick="toggleWeight('${exp.id}','${m.id}')" class="py-3 px-4 rounded-2xl font-bold border-2 transition-all ${exp.weights?.[m.id]>0?'bg-indigo-600 border-indigo-600 text-white shadow-lg':'bg-white border-slate-100 text-slate-400'}">
                                        ${escapeHtml(m.name)}
                                    </button>
                                    <div class="flex items-center justify-center gap-1 ${exp.weights?.[m.id]>0?'opacity-100':'opacity-0 pointer-events-none'}">
                                        <button onclick="changeWeight('${exp.id}','${m.id}',-0.1)" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">ー</button>
                                        <input type="number" step="0.1" value="${exp.weights?.[m.id] || 0}" 
                                            onclick="this.select()" 
                                            oninput="updateWeightDirectly('${exp.id}','${m.id}',this.value)"
                                            class="w-12 text-center font-black text-sm bg-transparent border-none outline-none">
                                        <button onclick="changeWeight('${exp.id}','${m.id}',0.1)" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">＋</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="pt-4 space-y-3 border-t border-slate-100">
                        <button onclick="closeExpenseModal()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors">
                            保存して閉じる
                        </button>
                        <button onclick="deleteExpense('${exp.id}');closeExpenseModal();" class="w-full py-3 text-rose-500 font-bold text-sm hover:bg-rose-50 rounded-2xl transition-colors">
                            この支出を削除する
                        </button>
                    </div>
                </div>
            `;

            // 入力監視の設定
            const updateAll = () => {
                exp.title = document.getElementById('modal_title').value;
                exp.payerId = document.getElementById('modal_payer').value;
                exp.amount = parseFloat(document.getElementById('modal_amount').value) || 0;
                render();
                triggerAutoSave();
            };
            document.getElementById('modal_title').oninput = updateAll;
            document.getElementById('modal_payer').onchange = updateAll;
            document.getElementById('modal_amount').oninput = updateAll;

            const modal = document.getElementById('expenseModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('.bottom-sheet').classList.add('active'), 10);
        }

        // Weightを直接入力したとき用
        function updateWeightDirectly(expId, mId, val) {
            const exp = state.expenses.find(e => e.id === expId);
            exp.weights[mId] = parseFloat(val) || 0;
            render();
            triggerAutoSave();
        }

        // 0.1刻みのWeight変更用
        function changeWeight(expId, mId, diff) {
            const exp = state.expenses.find(e => e.id === expId);
            // 浮動小数点の計算ミスを防ぐため10倍して計算
            let current = Math.round((exp.weights[mId] || 0) * 10);
            let change = Math.round(diff * 10);
            exp.weights[mId] = Math.max(0, (current + change) / 10);
            render();
            openExpenseModal(expId); // 再描画して数値を反映
            triggerAutoSave();
        }

        function addAmount(id, val) { 
            const exp = state.expenses.find(e=>e.id===id); 
            exp.amount = (parseFloat(exp.amount)||0) + val; 
            render(); 
            openExpenseModal(id); 
            triggerAutoSave(); 
        }
        
        function toggleWeight(expId, mId) { 
            const exp = state.expenses.find(e=>e.id===expId); 
            exp.weights[mId] = exp.weights[mId] > 0 ? 0 : 1; 
            render(); 
            openExpenseModal(expId); 
            triggerAutoSave(); 
        }

        function toggleWeightInTable(expId, mId) {
            const exp = state.expenses.find(e=>e.id===expId);
            exp.weights[mId] = exp.weights[mId] > 0 ? 0 : 1;
            render();
            triggerAutoSave();
        }
        
        function closeExpenseModal() { 
            const sheet = document.getElementById('expenseModal').querySelector('.bottom-sheet'); 
            sheet.classList.remove('active'); 
            setTimeout(() => document.getElementById('expenseModal').classList.add('hidden'), 300); 
        }
        
        function switchTab(t) { 
            document.getElementById('view-input').classList.toggle('hidden', t!=='input'); 
            document.getElementById('view-list').classList.toggle('hidden', t!=='list'); 
            const bI=document.getElementById('tab-input'), bL=document.getElementById('tab-list'), 
            active="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-200", 
            inactive="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold transition-all text-slate-400 hover:bg-slate-50"; 
            bI.className = t==='input'?active:inactive; 
            bL.className = t==='list'?active:inactive; 
        }
        
        function createNewExpense(e) { 
            if(state.members.length===0) return openMemberManager(); 
            const id='e_'+Math.random().toString(36).substr(2,9), weights={}; 
            state.members.forEach(m=>weights[m.id]=1); 
            state.expenses.unshift({id, title:'', amount:0, payerId:state.members[0].id, weights}); 
            render(); 
            openExpenseModal(id); 
        }
        
        function deleteExpense(id) { 
            if(!confirm('この支出を削除してもよろしいですか？')) return; 
            state.expenses = state.expenses.filter(e=>e.id!==id); 
            render(); 
            triggerAutoSave(); 
        }
        
        function openMemberManager() { 
            renderMemberList(); 
            const m=document.getElementById('memberModal'); 
            m.classList.remove('hidden'); 
            setTimeout(()=>m.querySelector('.bottom-sheet').classList.add('active'),10); 
        }
        
        function closeMemberModal() { 
            const s=document.getElementById('memberModal').querySelector('.bottom-sheet'); 
            s.classList.remove('active'); 
            setTimeout(()=>document.getElementById('memberModal').classList.add('hidden'),300); 
        }
        
        function renderMemberList() { 
            document.getElementById('memberListContent').innerHTML = state.members.map(m=>
                `<div class="flex items-center gap-3 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                    <input type="text" value="${escapeHtml(m.name)}" onchange="updateMemberName('${m.id}',this.value)" class="flex-1 bg-transparent border-none font-bold text-slate-800 outline-none focus:ring-0">
                    <button onclick="removeMember('${m.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" size="18"></i></button>
                </div>`
            ).join(''); 
            if(window.lucide) lucide.createIcons(); 
        }
        
        function addMember(e) { 
            const id='m_'+Math.random().toString(36).substr(2,9); 
            state.members.push({id, name:'新規メンバー'}); 
            render(); 
            renderMemberList(); 
            triggerAutoSave(); 
            
            // 追加した直後に該当の入力欄にフォーカス&全選択
            setTimeout(() => {
                const inputs = document.querySelectorAll('#memberListContent input[type="text"]');
                const lastInput = inputs[inputs.length - 1];
                if (lastInput) {
                    lastInput.focus();
                    lastInput.select();
                }
            }, 50);
        }
        
        function updateMemberName(id,n) { 
            const m=state.members.find(m=>m.id===id); 
            if(m) m.name=n; 
            render(); 
            triggerAutoSave(); 
        }
        
        function removeMember(id) { 
            if(!confirm('メンバーを削除しますか？')) return; 
            state.members=state.members.filter(m=>m.id!==id); 
            render(); 
            renderMemberList(); 
            triggerAutoSave(); 
        }
        
        function triggerAutoSave() { 
            if(autoSaveTimer) clearTimeout(autoSaveTimer); 
            autoSaveTimer=setTimeout(()=>{ syncData(); },2000); 
        }
        
        async function fetchData() { 
            try { 
                const res=await fetch(`${gasUrl}?pid=${state.projectId}`); 
                const data=await res.json(); 
                if(data.members){ 
                    state=data; 
                    render(); 
                } 
            } catch(e){
                console.error('データ取得エラー:', e);
            } 
        }
        
        async function syncData() { 
            try { 
                await fetch(gasUrl, {method:'POST', body:JSON.stringify(state)}); 
            } catch(e){
                console.error('同期エラー:', e);
            } 
        }
        
        function createNewProject() {
            if (!confirm('新しいプロジェクトを作成しますか？\n現在の内容は保存されています。')) return;
            
            // 新しいプロジェクトIDを生成
            const newPid = 'p_' + Math.random().toString(36).substr(2, 9);
            
            // 新しいプロジェクトに切り替え
            localStorage.setItem('fs_last_pid', newPid);
            
            // URLを更新（リロードなし）
            const newUrl = window.location.origin + window.location.pathname + '?pid=' + newPid;
            window.history.pushState({}, '', newUrl);
            
            // 新しい空のstateで初期化
            state = {
                projectId: newPid,
                title: '新しい旅行',
                members: [],
                expenses: []
            };
            
            document.getElementById('projectIdDisplay').innerText = `ID: ${newPid}`;
            document.getElementById('projectTitle').value = '新しい旅行';
            
            render();
            syncData(); // 即座に空のプロジェクトをGASに保存
            
            alert('新しいプロジェクトを作成しました！');
        }
        
        function copyShareUrl() { 
            const url = window.location.origin + window.location.pathname + '?pid=' + state.projectId; 
            navigator.clipboard.writeText(url).then(() => alert('URLをコピーしました！')); 
        }
    </script>
</body>
</html>