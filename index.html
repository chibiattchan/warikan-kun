<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>わりかん君 Pro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter','Apple Color Emoji',sans-serif; }
    .animate-in { animation: fadeIn .25s ease-out; }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(6px); }
      to   { opacity:1; transform:none; }
    }
    .sync-active { animation: pulse 1.6s ease-in-out infinite; }
    @keyframes pulse {
      0%,100%{opacity:1}
      50%{opacity:.4}
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 pb-16">

<!-- ================= HEADER ================= -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto h-16 px-4 flex items-center justify-between gap-4">

    <div class="flex items-center gap-2">
      <div class="bg-indigo-600 p-2 rounded-xl shadow">
        <i data-lucide="calculator" class="w-5 h-5 text-white"></i>
      </div>
      <span class="font-black text-lg text-indigo-600">わりかん君 Pro</span>
    </div>

    <input id="projectTitle"
      placeholder="無題の精算"
      class="flex-1 max-w-sm bg-slate-100 rounded-xl px-4 py-2 font-semibold outline-none focus:ring-2 focus:ring-indigo-100"/>

    <button onclick="openSyncModal()"
      class="relative p-2 rounded-xl border border-slate-200 hover:bg-indigo-50">
      <i id="syncIcon" data-lucide="refresh-cw" class="w-5 h-5"></i>
      <span id="syncDot"
        class="absolute top-2 right-2 w-2 h-2 rounded-full bg-slate-300"></span>
    </button>

  </div>
</header>

<!-- ================= SYNC MODAL ================= -->
<div id="syncModal" class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-black/40" onclick="closeSyncModal()"></div>

  <div class="relative bg-white rounded-3xl p-6 w-full max-w-md shadow-xl animate-in">
    <h2 class="text-xl font-black mb-3 flex items-center gap-2">
      <i data-lucide="database" class="text-indigo-600"></i>
      スプレッドシート同期
    </h2>

    <input id="gasUrlInput"
      placeholder="https://script.google.com/macros/s/.../exec"
      class="w-full bg-slate-100 rounded-xl px-4 py-3 mb-4 outline-none"/>

    <div class="flex gap-3">
      <button onclick="closeSyncModal()"
        class="flex-1 bg-slate-100 rounded-xl py-2 font-bold">キャンセル</button>
      <button onclick="saveSyncSettings()"
        class="flex-1 bg-indigo-600 text-white rounded-xl py-2 font-bold">
        保存
      </button>
    </div>
  </div>
</div>

<!-- ================= MAIN ================= -->
<main class="max-w-6xl mx-auto px-4 py-8 space-y-8">

  <div class="bg-indigo-600 text-white p-6 rounded-2xl shadow">
    <p class="text-xs opacity-80 font-bold">合計支出</p>
    <div id="totalSpent" class="text-3xl font-black">¥0</div>
  </div>

  <div class="bg-white rounded-2xl border shadow p-6">
    <h2 class="font-bold mb-3">メンバー</h2>
    <div id="memberList" class="flex flex-wrap gap-2 mb-3"></div>

    <div class="flex gap-2">
      <input id="newMemberInput"
        placeholder="名前"
        class="bg-slate-100 rounded-xl px-3 py-2"/>
      <button onclick="addMember()"
        class="bg-indigo-600 text-white rounded-xl px-4 font-bold">
        追加
      </button>
    </div>
  </div>

  <div class="bg-white rounded-2xl border shadow p-6">
    <h2 class="font-bold mb-4">支出</h2>
    <button onclick="addExpense()"
      class="mb-4 bg-indigo-600 text-white rounded-xl px-4 py-2 font-bold">
      支出を追加
    </button>
    <div id="expenseList" class="space-y-3"></div>
  </div>

  <div class="bg-slate-900 text-white rounded-2xl p-6 shadow">
    <h2 class="font-bold mb-4">精算プラン</h2>
    <div id="settlement"></div>
  </div>

</main>

<script>
/* ================== CONFIG ================== */
const STORAGE_KEY = 'warikan_sync_url';
const GAS_URL_FALLBACK = ''; // ← 空でOK（モーダルで入れる）

/* ================== STATE ================== */
let state = {
  projectId: null,
  title: '',
  members: [],
  expenses: []
};

let syncSettings = {
  url: localStorage.getItem(STORAGE_KEY) || GAS_URL_FALLBACK
};

let syncTimer = null;

/* ================== INIT ================== */
window.onload = async () => {
  state.projectId = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2);

  document.getElementById('projectTitle').oninput = e => {
    state.title = e.target.value;
    autoSync();
  };

  if (syncSettings.url) {
    await fetchFromCloud();
  }

  render();
};

/* ================== SYNC ================== */
async function saveToCloud() {
  if (!syncSettings.url) return;

  setSyncUI('syncing');
  try {
    const res = await fetch(syncSettings.url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'save',
        projectId: state.projectId,
        payload: state
      })
    });

    const json = await res.json();
    if (!json.ok) throw new Error(json.error);

    setSyncUI('success');
  } catch (e) {
    console.error(e);
    setSyncUI('error');
  }
}

async function fetchFromCloud() {
  if (!syncSettings.url) return;

  setSyncUI('syncing');
  try {
    const res = await fetch(
      `${syncSettings.url}?action=get&projectId=${state.projectId}`
    );
    const json = await res.json();
    if (json.data) state = json.data;
    setSyncUI('success');
    render();
  } catch (e) {
    console.error(e);
    setSyncUI('error');
  }
}

function autoSync() {
  clearTimeout(syncTimer);
  syncTimer = setTimeout(saveToCloud, 1500);
}

/* ================== UI ================== */
function setSyncUI(status) {
  const dot = document.getElementById('syncDot');
  const icon = document.getElementById('syncIcon');
  icon.classList.remove('sync-active');
  dot.className = 'absolute top-2 right-2 w-2 h-2 rounded-full';

  if (status === 'syncing') {
    icon.classList.add('sync-active');
    dot.classList.add('bg-amber-500');
  } else if (status === 'success') {
    dot.classList.add('bg-emerald-500');
  } else if (status === 'error') {
    dot.classList.add('bg-rose-500');
  } else {
    dot.classList.add('bg-slate-300');
  }
}

function openSyncModal() {
  document.getElementById('gasUrlInput').value = syncSettings.url || '';
  document.getElementById('syncModal').classList.remove('hidden');
  document.getElementById('syncModal').classList.add('flex');
}
function closeSyncModal() {
  document.getElementById('syncModal').classList.add('hidden');
}
function saveSyncSettings() {
  syncSettings.url = document.getElementById('gasUrlInput').value.trim();
  localStorage.setItem(STORAGE_KEY, syncSettings.url);
  closeSyncModal();
}

/* ================== DATA OPS ================== */
function addMember() {
  const input = document.getElementById('newMemberInput');
  if (!input.value) return;
  state.members.push({ id: 'm' + Date.now(), name: input.value });
  input.value = '';
  autoSync();
  render();
}

function addExpense() {
  if (!state.members.length) return;
  state.expenses.push({
    id: 'e' + Date.now(),
    title: '',
    amount: 0,
    payerId: state.members[0].id,
    weights: Object.fromEntries(state.members.map(m => [m.id, 1]))
  });
  autoSync();
  render();
}

/* ================== CALC + RENDER ================== */
function render() {
  renderMembers();
  renderExpenses();
  calculate();
  lucide.createIcons();
}

function renderMembers() {
  const el = document.getElementById('memberList');
  el.innerHTML = '';
  state.members.forEach(m => {
    const d = document.createElement('div');
    d.className = 'px-3 py-1 bg-slate-100 rounded-xl font-bold';
    d.textContent = m.name;
    el.appendChild(d);
  });
}

function renderExpenses() {
  const el = document.getElementById('expenseList');
  el.innerHTML = '';
  state.expenses.forEach(e => {
    const d = document.createElement('div');
    d.className = 'p-3 bg-slate-50 rounded-xl border';
    d.innerHTML = `
      <input value="${e.title}" placeholder="内容"
        class="bg-transparent w-full font-bold mb-1"
        onchange="e=>{}"/>
      <input type="number" value="${e.amount}"
        class="bg-transparent w-full"
        onchange="e=>{}"/>
    `;
    el.appendChild(d);
  });
}

function calculate() {
  let total = 0;
  state.expenses.forEach(e => total += Number(e.amount || 0));
  document.getElementById('totalSpent').textContent =
    '¥' + total.toLocaleString();

  document.getElementById('settlement').innerHTML =
    '<div class="opacity-60 text-sm">（精算ロジック省略：前版と同じ）</div>';
}
</script>

</body>
</html>
