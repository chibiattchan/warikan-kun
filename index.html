<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>優秀わりかん君</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter','Apple Color Emoji',sans-serif; }
    .sync-active { animation: pulse 1.6s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.45} }
    .no-scrollbar::-webkit-scrollbar { display:none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 pb-24">

<!-- ===== Header ===== -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto h-16 px-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-2 min-w-0">
      <div class="bg-indigo-600 p-2 rounded-xl shadow shadow-indigo-100">
        <i data-lucide="calculator" class="w-5 h-5 text-white"></i>
      </div>
      <div class="min-w-0">
        <div class="font-black text-indigo-700 leading-tight truncate">優秀わりかん君</div>
        <div class="text-[11px] text-slate-500 truncate">
          旅の名前：<span id="currentProjectName" class="font-bold">（未設定）</span>
          <span class="text-slate-300 mx-1">|</span>
          <span class="text-slate-400">pid:</span><span id="pidBadge" class="font-mono text-slate-500">-</span>
        </div>
      </div>
    </div>

    <input id="projectTitle"
      placeholder="例：沖縄旅行2026"
      class="flex-1 max-w-sm bg-slate-100 rounded-xl px-4 py-2 font-semibold outline-none focus:ring-2 focus:ring-indigo-100"/>

    <div class="flex items-center gap-2">
      <button onclick="copyShareLink()"
        class="p-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 active:scale-95 transition"
        title="URLをコピー">
        <i data-lucide="share-2" class="w-5 h-5 text-slate-600"></i>
      </button>

      <button onclick="openSyncModal()"
        class="relative p-2 rounded-xl border border-slate-200 bg-white hover:bg-indigo-50 active:scale-95 transition"
        title="スプレッドシート同期">
        <i id="syncIcon" data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i>
        <span id="syncDot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-slate-300"></span>
      </button>
    </div>
  </div>
</header>

<!-- ===== Summary ===== -->
<section class="max-w-6xl mx-auto px-4 pt-5 space-y-4">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-indigo-600 text-white rounded-2xl p-5 shadow shadow-indigo-100 relative overflow-hidden">
      <div class="relative z-10">
        <div class="text-xs font-bold opacity-80">合計支出</div>
        <div id="totalSpent" class="text-3xl font-black mt-1">¥0</div>
      </div>
      <i data-lucide="dollar-sign" class="absolute -right-6 -bottom-6 w-24 h-24 text-white/10 rotate-12"></i>
    </div>

    <div class="md:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
      <div class="flex items-center justify-between gap-2 mb-2">
        <div class="font-black">メンバー</div>
        <button onclick="addExpense()"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-600 text-white font-bold text-sm shadow shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition">
          <i data-lucide="plus" class="w-4 h-4"></i> 支出を追加
        </button>
      </div>

      <div id="memberChips" class="flex flex-wrap gap-2 mb-3"></div>

      <div class="flex gap-2">
        <input id="newMemberInput" placeholder="名前を追加"
          class="flex-1 bg-slate-100 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-100 font-semibold"/>
        <button onclick="addMember()"
          class="px-4 py-2 rounded-xl bg-slate-900 text-white font-black hover:bg-slate-800 active:scale-95 transition">
          追加
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white border border-slate-200 rounded-3xl p-1 flex gap-1 shadow-sm">
    <button id="tabCard" onclick="setViewTab('card')" class="flex-1 py-2 rounded-2xl text-sm font-black transition-all">かんたん入力</button>
    <button id="tabTable" onclick="setViewTab('table')" class="flex-1 py-2 rounded-2xl text-sm font-black transition-all">一覧で確認</button>
  </div>
</section>

<!-- ===== Panels ===== -->
<main class="max-w-6xl mx-auto px-4 py-4 space-y-6">

  <!-- Card panel -->
  <section id="panelCard" class="space-y-4"></section>

  <!-- Table panel -->
  <section id="panelTable" class="hidden">
    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="overflow-x-auto no-scrollbar">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-[10px] uppercase tracking-wide text-slate-500 font-black">
            <tr id="tableHeaderRow"></tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
      <div class="px-4 py-3 text-[11px] text-slate-500 border-t border-slate-200">
        スマホでは「行タップ」で下から編集シートが出ます（PCでも使えます）。
      </div>
    </div>
  </section>

  <!-- Results -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
      <div class="flex items-center gap-2 mb-4">
        <i data-lucide="pie-chart" class="w-5 h-5 text-slate-400"></i>
        <div class="font-black">個人別の収支</div>
      </div>
      <div id="balanceList" class="space-y-2"></div>
    </div>

    <div class="bg-slate-900 text-white rounded-2xl p-5 shadow-xl">
      <div class="flex items-center gap-2 mb-4 text-indigo-300">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <div class="font-black">精算プラン</div>
      </div>
      <div id="settlementPlan" class="space-y-2"></div>
      <div class="mt-4 text-[10px] text-slate-500 text-center">※送金回数が少なくなるよう最適化</div>
    </div>
  </section>
</main>

<!-- ===== Sync modal ===== -->
<div id="syncModal" class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeSyncModal()"></div>
  <div class="relative bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl m-4">
    <div class="flex items-center gap-2 mb-2">
      <i data-lucide="database" class="text-indigo-600"></i>
      <div class="text-xl font-black">スプレッドシート同期</div>
    </div>
    <div class="text-sm text-slate-500 mb-4">
      GAS Web App URL を入れると、この旅の状態をスプシに保存・復元できます。
    </div>
    <input id="gasUrlInput"
      placeholder="https://script.google.com/macros/s/.../exec"
      class="w-full bg-slate-100 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 font-semibold"/>
    <div class="flex gap-2 mt-5">
      <button onclick="closeSyncModal()"
        class="flex-1 bg-slate-100 rounded-2xl py-2 font-black hover:bg-slate-200 transition">キャンセル</button>
      <button onclick="saveSyncSettings()"
        class="flex-1 bg-indigo-600 text-white rounded-2xl py-2 font-black shadow shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition">保存</button>
    </div>
  </div>
</div>

<!-- ===== Bottom sheet overlay ===== -->
<div id="sheetOverlay" class="fixed inset-0 z-50 hidden bg-black/40"></div>

<!-- ===== Bottom sheet ===== -->
<div id="expenseSheet" class="fixed bottom-0 left-0 right-0 z-50 translate-y-full transition-transform duration-200">
  <div class="max-w-2xl mx-auto bg-white rounded-t-3xl border border-slate-200 shadow-2xl p-5">
    <div class="flex items-center justify-between mb-3">
      <div class="font-black text-lg">支出を編集</div>
      <button onclick="closeExpenseSheet()" class="p-2 rounded-xl hover:bg-slate-100">
        <i data-lucide="x"></i>
      </button>
    </div>

    <div class="space-y-3">
      <div>
        <div class="text-xs font-black text-slate-500 mb-1">内容</div>
        <input id="sheetExpenseTitle"
          class="w-full bg-slate-100 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-indigo-100"
          oninput="sheetUpdateTitle(this.value)" />
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-xs font-black text-slate-500 mb-1">金額</div>
          <input id="sheetExpenseAmount" type="number" inputmode="numeric"
            class="w-full bg-slate-100 rounded-2xl px-4 py-3 font-black outline-none focus:ring-2 focus:ring-indigo-100 text-right"
            oninput="sheetUpdateAmount(this.value)" />
        </div>
        <div>
          <div class="text-xs font-black text-slate-500 mb-1">支払人</div>
          <select id="sheetExpensePayer"
            class="w-full bg-slate-100 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-indigo-100"
            onchange="sheetUpdatePayer(this.value)"></select>
        </div>
      </div>

      <div>
        <div class="text-xs font-black text-slate-500 mb-2">Weight（参加=1 / 不参加=0、数値もOK）</div>
        <div id="sheetWeights" class="space-y-2"></div>
      </div>

      <div class="flex items-center justify-between pt-2">
        <button onclick="deleteExpense(activeEditExpenseId); closeExpenseSheet();"
          class="px-4 py-2 rounded-2xl bg-rose-50 text-rose-600 font-black border border-rose-200 hover:bg-rose-100 transition">
          <span class="inline-flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i>削除</span>
        </button>

        <button onclick="closeExpenseSheet()"
          class="px-5 py-2 rounded-2xl bg-indigo-600 text-white font-black shadow shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition">
          完了
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Toast ===== -->
<div id="toast"
  class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60]
         bg-slate-900 text-white px-4 py-2 rounded-2xl shadow
         opacity-0 translate-y-2 transition-all duration-200 text-sm font-bold">
  OK
</div>

<script>
/* ===================== Utilities ===================== */
function escapeHtml(s) {
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function fmtJPY(n) {
  const v = Math.round(Number(n) || 0);
  return `¥${v.toLocaleString()}`;
}
function toNum(v, fallback=0) {
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}
function round1(n) { return Math.round(n * 10) / 10; }

let toastTimer = null;
function toast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.remove('opacity-0','translate-y-2');
  t.classList.add('opacity-100','translate-y-0');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    t.classList.remove('opacity-100','translate-y-0');
    t.classList.add('opacity-0','translate-y-2');
  }, 1600);
}

/* ===================== URL / PID ===================== */
function getPidFromUrl() {
  return new URLSearchParams(location.search).get('pid');
}
function setPidToUrl(pid) {
  const url = new URL(location.href);
  url.searchParams.set('pid', pid);
  history.replaceState(null, '', url.toString());
}
function generatePid() {
  // 推測されにくい長めのID
  const a = crypto?.getRandomValues ? crypto.getRandomValues(new Uint8Array(16)) : Array.from({length:16},()=>Math.floor(Math.random()*256));
  const hex = Array.from(a, b => b.toString(16).padStart(2,'0')).join('');
  return 'p_' + Date.now() + '_' + hex;
}
function getShareUrl() {
  const url = new URL(location.href);
  url.searchParams.set('pid', state.projectId);
  return url.toString();
}

/* ===================== State ===================== */
let state = {
  projectId: null,
  title: '',
  viewTab: 'card',
  members: [],
  expenses: []
};

/* ===================== Sync settings ===================== */
const GAS_URL_KEY = 'warikan_gas_url';
let syncSettings = {
  url: localStorage.getItem(GAS_URL_KEY) || '',
  isSyncing: false
};
let syncTimer = null;

function updateSyncUI(status) {
  const dot = document.getElementById('syncDot');
  const icon = document.getElementById('syncIcon');
  if (!dot || !icon) return;

  icon.classList.remove('sync-active');
  dot.classList.remove('bg-slate-300','bg-emerald-500','bg-rose-500','bg-amber-500');

  if (status === 'syncing') {
    icon.classList.add('sync-active');
    dot.classList.add('bg-amber-500');
  } else if (status === 'success') {
    dot.classList.add('bg-emerald-500');
  } else if (status === 'error') {
    dot.classList.add('bg-rose-500');
  } else {
    dot.classList.add('bg-slate-300');
  }
}

async function saveToCloud() {
  if (!syncSettings.url) return;
  updateSyncUI('syncing');

  try {
    const body = {
      action: 'save',
      projectId: state.projectId,
      projectName: state.title || '',
      shareUrl: getShareUrl(),
      payload: state,
      updatedAt: new Date().toISOString()
    };

    const res = await fetch(syncSettings.url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    // GASが {ok:true} を返す想定。no-corsは使わない。
    const json = await res.json();
    if (!json || json.ok !== true) throw new Error(json?.error || 'sync failed');
    updateSyncUI('success');
  } catch (e) {
    console.error(e);
    updateSyncUI('error');
  }
}

async function fetchFromCloud() {
  if (!syncSettings.url) return false;
  updateSyncUI('syncing');

  try {
    const url = new URL(syncSettings.url);
    url.searchParams.set('action', 'get');
    url.searchParams.set('projectId', state.projectId);

    const res = await fetch(url.toString(), { method: 'GET' });
    const json = await res.json();

    if (json && json.data) {
      state = json.data;
      // pidだけはURL優先で維持
      state.projectId = getPidFromUrl() || state.projectId;
      updateSyncUI('success');
      return true;
    }

    updateSyncUI('success');
    return false;
  } catch (e) {
    console.error(e);
    updateSyncUI('error');
    return false;
  }
}

function triggerAutoSync() {
  if (!syncSettings.url) return;
  clearTimeout(syncTimer);
  updateSyncUI('syncing');
  syncTimer = setTimeout(saveToCloud, 1200);
}

/* ===================== Tabs ===================== */
function tabBtnClass_(active) {
  return [
    'flex-1 py-2 rounded-2xl text-sm font-black transition-all',
    active ? 'bg-indigo-600 text-white shadow shadow-indigo-100' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
  ].join(' ');
}
function setViewTab(tab) {
  state.viewTab = tab;
  localStorage.setItem('warikan_view_tab', tab);
  renderTabs();
  render();
}
function renderTabs() {
  const card = document.getElementById('tabCard');
  const table = document.getElementById('tabTable');
  const cardPanel = document.getElementById('panelCard');
  const tablePanel = document.getElementById('panelTable');

  const isCard = (state.viewTab || 'card') === 'card';
  if (card) card.className = tabBtnClass_(isCard);
  if (table) table.className = tabBtnClass_(!isCard);

  if (cardPanel) cardPanel.classList.toggle('hidden', !isCard);
  if (tablePanel) tablePanel.classList.toggle('hidden', isCard);
}

/* ===================== Members / Expenses ===================== */
function addMember() {
  const input = document.getElementById('newMemberInput');
  const name = input.value.trim();
  if (!name) return;

  const id = 'm' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  state.members.push({ id, name });

  // 途中参加：過去支出にはデフォ0（必要なら手で入れる）
  state.expenses.forEach(e => {
    if (!e.weights) e.weights = {};
    e.weights[id] = 0;
  });

  input.value = '';
  calculateAndRender();
}

function deleteMember(mid) {
  if (state.members.length <= 1) return;
  state.members = state.members.filter(m => m.id !== mid);

  state.expenses.forEach(e => {
    if (e.weights) delete e.weights[mid];
    if (e.payerId === mid) e.payerId = state.members[0]?.id || '';
  });

  calculateAndRender();
}

function addExpense() {
  if (state.members.length === 0) return;

  const id = 'e' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  const weights = {};
  state.members.forEach(m => weights[m.id] = 1);

  state.expenses.push({
    id,
    title: '',
    amount: 0,
    payerId: state.members[0].id,
    weights
  });

  calculateAndRender();

  // モバイルならすぐ編集シート開くと気持ちいい
  if (window.matchMedia('(max-width: 768px)').matches) {
    openExpenseSheet(id);
  }
}

function deleteExpense(eid) {
  if (!eid) return;
  state.expenses = state.expenses.filter(e => e.id !== eid);
  calculateAndRender();
}

function updateExpenseField(eid, field, value) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;

  if (field === 'amount') exp.amount = toNum(value, 0);
  else exp[field] = value;

  calculateAndRender();
}

function setWeight(eid, mid, value) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;
  if (!exp.weights) exp.weights = {};
  let n = toNum(value, 0);
  if (n < 0) n = 0;
  exp.weights[mid] = n;
  calculateAndRender(false); // ここでシート描画を壊さない
}

function stepWeight(eid, mid, delta) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;
  if (!exp.weights) exp.weights = {};
  const cur = toNum(exp.weights[mid], 0);
  let next = round1(cur + delta);
  if (next < 0) next = 0;
  exp.weights[mid] = next;
  calculateAndRender(false);
}

function toggleWeight01(eid, mid) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;
  if (!exp.weights) exp.weights = {};
  const cur = toNum(exp.weights[mid], 0);
  exp.weights[mid] = cur > 0 ? 0 : 1;
  calculateAndRender(false);
}

/* ===================== Calculation ===================== */
function calculate() {
  const balances = {};
  state.members.forEach(m => balances[m.id] = 0);

  let totalSpent = 0;

  state.expenses.forEach(exp => {
    const amount = toNum(exp.amount, 0);
    totalSpent += amount;

    // payer +amount
    if (balances[exp.payerId] !== undefined) balances[exp.payerId] += amount;

    // split by weights
    let totalW = 0;
    state.members.forEach(m => totalW += toNum(exp.weights?.[m.id], 0));

    if (totalW > 0) {
      const perW = amount / totalW;
      state.members.forEach(m => {
        balances[m.id] -= toNum(exp.weights?.[m.id], 0) * perW;
      });
    }
  });

  // settlement plan (min transfers)
  const debtors = [];
  const creditors = [];
  Object.entries(balances).forEach(([id, amt]) => {
    if (amt < -0.01) debtors.push({ id, amt });
    else if (amt > 0.01) creditors.push({ id, amt });
  });

  debtors.sort((a,b) => a.amt - b.amt);     // more negative first
  creditors.sort((a,b) => b.amt - a.amt);   // more positive first

  const plan = [];
  let i = 0, j = 0;
  const d = debtors.map(x => ({...x}));
  const c = creditors.map(x => ({...x}));

  while (i < d.length && j < c.length) {
    const settle = Math.min(Math.abs(d[i].amt), c[j].amt);
    if (settle > 0.009) {
      plan.push({
        from: state.members.find(m => m.id === d[i].id)?.name || d[i].id,
        to: state.members.find(m => m.id === c[j].id)?.name || c[j].id,
        amount: settle
      });
    }
    d[i].amt += settle;   // less negative
    c[j].amt -= settle;   // less positive
    if (Math.abs(d[i].amt) < 0.01) i++;
    if (c[j].amt < 0.01) j++;
  }

  return { totalSpent, balances, plan };
}

/* ===================== Render ===================== */
function updateHeaderUI() {
  document.getElementById('currentProjectName').textContent = state.title || '（未設定）';
  document.getElementById('pidBadge').textContent = state.projectId || '-';
  const titleInput = document.getElementById('projectTitle');
  if (titleInput && titleInput.value !== (state.title || '')) {
    titleInput.value = state.title || '';
  }
}

function renderMemberChips() {
  const wrap = document.getElementById('memberChips');
  wrap.innerHTML = '';

  state.members.forEach(m => {
    const chip = document.createElement('div');
    chip.className = 'flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-2xl px-3 py-2';
    chip.innerHTML = `
      <div class="w-7 h-7 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[11px] font-black text-slate-600">
        ${escapeHtml(m.name.slice(0,1))}
      </div>
      <div class="font-black text-sm max-w-[140px] truncate">${escapeHtml(m.name)}</div>
      <button class="ml-1 text-slate-400 hover:text-rose-500 transition" title="削除"
        onclick="deleteMember('${m.id}')">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    `;
    wrap.appendChild(chip);
  });
}

function renderCards() {
  const panel = document.getElementById('panelCard');
  panel.innerHTML = '';

  if (state.expenses.length === 0) {
    panel.innerHTML = `
      <div class="bg-white border border-slate-200 rounded-2xl p-6 text-center text-slate-500">
        支出がまだありません。「支出を追加」から始めよう！
      </div>`;
    return;
  }

  state.expenses.forEach(exp => {
    const card = document.createElement('div');
    card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';

    const weightsUI = state.members.map(m => {
      const w = toNum(exp.weights?.[m.id], 0);
      const on = w > 0;

      return `
        <div class="flex items-center justify-between bg-slate-50 border border-slate-200 rounded-2xl px-3 py-2">
          <div class="flex items-center gap-2 min-w-0">
            <div class="w-7 h-7 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[11px] font-black text-slate-600">
              ${escapeHtml(m.name.slice(0,1))}
            </div>
            <div class="font-bold truncate">${escapeHtml(m.name)}</div>
          </div>

          <div class="flex items-center gap-2">
            <button class="w-10 h-10 rounded-2xl font-black border transition-all ${on ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'}"
              onclick="toggleWeight01('${exp.id}','${m.id}')">${on ? '1' : '0'}</button>

            <div class="flex items-center bg-white border border-slate-200 rounded-2xl overflow-hidden">
              <button class="w-10 h-10 text-slate-600 font-black hover:bg-slate-50"
                onclick="stepWeight('${exp.id}','${m.id}',-0.1)">−</button>
              <input class="w-20 h-10 text-center font-black outline-none"
                inputmode="decimal"
                value="${String(w)}"
                onchange="setWeight('${exp.id}','${m.id}', this.value)" />
              <button class="w-10 h-10 text-slate-600 font-black hover:bg-slate-50"
                onclick="stepWeight('${exp.id}','${m.id}',0.1)">＋</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0">
          <input
            class="w-full bg-slate-100 rounded-2xl px-4 py-3 font-black outline-none focus:ring-2 focus:ring-indigo-100"
            placeholder="例：タクシー / ランチ"
            value="${escapeHtml(exp.title || '')}"
            onchange="updateExpenseField('${exp.id}','title', this.value)"
          />
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <div class="text-[11px] font-black text-slate-500 mb-1">金額</div>
              <input type="number" inputmode="numeric"
                class="w-full bg-slate-100 rounded-2xl px-4 py-3 font-black outline-none focus:ring-2 focus:ring-indigo-100 text-right"
                value="${exp.amount ?? ''}"
                onchange="updateExpenseField('${exp.id}','amount', this.value)"
              />
            </div>
            <div>
              <div class="text-[11px] font-black text-slate-500 mb-1">支払人</div>
              <select
                class="w-full bg-slate-100 rounded-2xl px-4 py-3 font-black outline-none focus:ring-2 focus:ring-indigo-100"
                onchange="updateExpenseField('${exp.id}','payerId', this.value)"
              >
                ${state.members.map(m => `<option value="${m.id}" ${m.id===exp.payerId?'selected':''}>${escapeHtml(m.name)}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>

        <button onclick="openExpenseSheet('${exp.id}')"
          class="p-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 active:scale-95 transition"
          title="詳細編集（下からシート）">
          <i data-lucide="edit-3" class="w-5 h-5 text-slate-600"></i>
        </button>
      </div>

      <div class="mt-4">
        <div class="text-[11px] font-black text-slate-500 mb-2">Weight</div>
        <div class="space-y-2">${weightsUI}</div>
      </div>
    `;

    panel.appendChild(card);
  });
}

function renderTable() {
  // header
  const headRow = document.getElementById('tableHeaderRow');
  headRow.innerHTML = `
    <th class="p-3 w-10"></th>
    <th class="p-3 min-w-[180px]">内容</th>
    <th class="p-3 w-[140px] text-right">金額</th>
    <th class="p-3 w-[160px]">支払人</th>
    ${state.members.map(m => `<th class="p-3 min-w-[90px] text-center border-l border-slate-200">${escapeHtml(m.name)}</th>`).join('')}
  `;

  // body
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  state.expenses.forEach(exp => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-indigo-50/40 transition cursor-pointer';

    const weightCells = state.members.map(m => {
      const w = toNum(exp.weights?.[m.id], 0);
      return `
        <td class="p-2 text-center border-l border-slate-100">
          <div class="flex items-center justify-center gap-1">
            <button class="w-9 h-9 rounded-2xl font-black border ${w>0?'bg-indigo-600 text-white border-indigo-600':'bg-white text-slate-400 border-slate-200'}"
              onclick="event.stopPropagation(); toggleWeight01('${exp.id}','${m.id}')">${w>0?'1':'0'}</button>
            <input class="w-16 h-9 bg-slate-50 border border-slate-200 rounded-2xl text-center font-black outline-none"
              inputmode="decimal"
              value="${String(w)}"
              onclick="event.stopPropagation();"
              onchange="setWeight('${exp.id}','${m.id}', this.value)" />
          </div>
        </td>
      `;
    }).join('');

    tr.innerHTML = `
      <td class="p-3 text-center">
        <button class="text-slate-400 hover:text-rose-500"
          onclick="event.stopPropagation(); deleteExpense('${exp.id}')">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      </td>

      <td class="p-2">
        <input class="w-full bg-transparent rounded-xl px-2 py-2 font-bold outline-none focus:ring-2 focus:ring-indigo-100"
          value="${escapeHtml(exp.title || '')}"
          onclick="event.stopPropagation();"
          onchange="updateExpenseField('${exp.id}','title', this.value)" />
      </td>

      <td class="p-2">
        <input type="number" class="w-full bg-slate-50 rounded-2xl px-3 py-2 font-black outline-none focus:ring-2 focus:ring-indigo-100 text-right"
          value="${exp.amount ?? ''}"
          onclick="event.stopPropagation();"
          onchange="updateExpenseField('${exp.id}','amount', this.value)" />
      </td>

      <td class="p-2">
        <select class="w-full bg-transparent rounded-xl px-2 py-2 font-black outline-none focus:ring-2 focus:ring-indigo-100"
          onclick="event.stopPropagation();"
          onchange="updateExpenseField('${exp.id}','payerId', this.value)">
          ${state.members.map(m => `<option value="${m.id}" ${m.id===exp.payerId?'selected':''}>${escapeHtml(m.name)}</option>`).join('')}
        </select>
      </td>

      ${weightCells}
    `;

    tr.addEventListener('click', () => openExpenseSheet(exp.id));
    tbody.appendChild(tr);
  });
}

function renderResults(totalSpent, balances, plan) {
  document.getElementById('totalSpent').innerText = fmtJPY(totalSpent);

  const bList = document.getElementById('balanceList');
  bList.innerHTML = '';
  state.members.forEach(m => {
    const v = balances[m.id] || 0;
    const isPos = v > 0.01;
    const isNeg = v < -0.01;

    const row = document.createElement('div');
    row.className = "flex items-center justify-between bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3";
    row.innerHTML = `
      <div class="flex items-center gap-2 min-w-0">
        <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs font-black text-slate-600">
          ${escapeHtml(m.name.slice(0,1))}
        </div>
        <div class="font-black truncate">${escapeHtml(m.name)}</div>
      </div>
      <div class="font-black ${isPos ? 'text-emerald-600' : isNeg ? 'text-rose-500' : 'text-slate-400'}">
        ${isPos ? '+' : ''}${fmtJPY(v)}
      </div>
    `;
    bList.appendChild(row);
  });

  const planWrap = document.getElementById('settlementPlan');
  planWrap.innerHTML = '';

  if (!plan || plan.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'py-8 text-center text-slate-500 text-sm italic';
    empty.innerText = 'すべての精算が完了しています';
    planWrap.appendChild(empty);
  } else {
    plan.forEach(p => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3';
      row.innerHTML = `
        <div class="flex items-center gap-2 min-w-0">
          <span class="font-bold text-rose-300 truncate">${escapeHtml(p.from)}</span>
          <svg class="w-4 h-4 text-slate-500 flex-shrink-0" viewBox="0 0 24 24" fill="none">
            <path d="M5 12h14M13 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="font-bold text-emerald-300 truncate">${escapeHtml(p.to)}</span>
        </div>
        <div class="text-lg font-black text-white">${fmtJPY(p.amount)}</div>
      `;
      planWrap.appendChild(row);
    });
  }
}

function render() {
  updateHeaderUI();
  renderTabs();
  renderMemberChips();
  renderCards();
  renderTable();

  const { totalSpent, balances, plan } = calculate();
  renderResults(totalSpent, balances, plan);

  try { lucide.createIcons(); } catch(e) {}
}

function calculateAndRender(doSheet=true) {
  render();
  triggerAutoSync();
  if (doSheet && activeEditExpenseId) renderExpenseSheet();
}

/* ===================== Bottom sheet ===================== */
let activeEditExpenseId = null;

function openExpenseSheet(eid) {
  activeEditExpenseId = eid;

  const overlay = document.getElementById('sheetOverlay');
  const sheet = document.getElementById('expenseSheet');
  if (!overlay || !sheet) return;

  renderExpenseSheet();

  overlay.classList.remove('hidden');
  sheet.classList.remove('translate-y-full');
  sheet.classList.add('translate-y-0');
}

function closeExpenseSheet() {
  activeEditExpenseId = null;

  const overlay = document.getElementById('sheetOverlay');
  const sheet = document.getElementById('expenseSheet');
  if (!overlay || !sheet) return;

  sheet.classList.remove('translate-y-0');
  sheet.classList.add('translate-y-full');
  setTimeout(() => overlay.classList.add('hidden'), 180);
}

function renderExpenseSheet() {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;

  const titleEl = document.getElementById('sheetExpenseTitle');
  const amountEl = document.getElementById('sheetExpenseAmount');
  const payerEl = document.getElementById('sheetExpensePayer');
  const weightsEl = document.getElementById('sheetWeights');

  if (titleEl) titleEl.value = exp.title || '';
  if (amountEl) amountEl.value = exp.amount ?? '';
  if (payerEl) {
    payerEl.innerHTML = state.members
      .map(m => `<option value="${m.id}" ${m.id === exp.payerId ? 'selected' : ''}>${escapeHtml(m.name)}</option>`)
      .join('');
  }

  if (weightsEl) {
    weightsEl.innerHTML = state.members.map(m => {
      const w = toNum(exp.weights?.[m.id], 0);
      const on = w > 0;
      return `
        <div class="flex items-center justify-between bg-slate-50 border border-slate-200 rounded-2xl px-3 py-2">
          <div class="flex items-center gap-2 min-w-0">
            <div class="w-7 h-7 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[11px] font-black text-slate-600">
              ${escapeHtml(m.name.slice(0,1))}
            </div>
            <div class="font-bold truncate">${escapeHtml(m.name)}</div>
          </div>

          <div class="flex items-center gap-2">
            <button class="w-10 h-10 rounded-2xl font-black border transition-all ${on ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'}"
              onclick="sheetToggle01('${exp.id}','${m.id}')">${on ? '1' : '0'}</button>

            <div class="flex items-center bg-white border border-slate-200 rounded-2xl overflow-hidden">
              <button class="w-10 h-10 text-slate-600 font-black hover:bg-slate-50"
                onclick="sheetStepWeight('${exp.id}','${m.id}',-0.1)">−</button>
              <input class="w-20 h-10 text-center font-black outline-none"
                inputmode="decimal"
                value="${String(w)}"
                onchange="sheetSetWeight('${exp.id}','${m.id}', this.value)" />
              <button class="w-10 h-10 text-slate-600 font-black hover:bg-slate-50"
                onclick="sheetStepWeight('${exp.id}','${m.id}',0.1)">＋</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  try { lucide.createIcons(); } catch(e) {}
}

function sheetUpdateTitle(v) {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;
  exp.title = v;
  calculateAndRender(false);
}
function sheetUpdateAmount(v) {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;
  exp.amount = toNum(v, 0);
  calculateAndRender(false);
}
function sheetUpdatePayer(v) {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;
  exp.payerId = v;
  calculateAndRender(false);
}
function sheetToggle01(eid, mid) {
  toggleWeight01(eid, mid);
  renderExpenseSheet();
}
function sheetSetWeight(eid, mid, val) {
  setWeight(eid, mid, val);
  renderExpenseSheet();
}
function sheetStepWeight(eid, mid, delta) {
  stepWeight(eid, mid, delta);
  renderExpenseSheet();
}

/* ===================== Share URL ===================== */
function copyShareLink() {
  const url = getShareUrl();
  navigator.clipboard?.writeText(url)
    .then(() => toast('URLをコピーしたよ！'))
    .catch(() => {
      const ta = document.createElement('textarea');
      ta.value = url;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      toast('URLをコピーしたよ！');
    });
}

/* ===================== Sync modal ===================== */
function openSyncModal() {
  document.getElementById('gasUrlInput').value = syncSettings.url || '';
  document.getElementById('syncModal').classList.remove('hidden');
  document.getElementById('syncModal').classList.add('flex');
}
function closeSyncModal() {
  document.getElementById('syncModal').classList.add('hidden');
}
async function saveSyncSettings() {
  const url = document.getElementById('gasUrlInput').value.trim();
  syncSettings.url = url;
  localStorage.setItem(GAS_URL_KEY, url);
  closeSyncModal();

  if (url) {
    // 最新取得を試みる（なければそのまま新規）
    const ok = await fetchFromCloud();
    render();
    triggerAutoSync(); // 今の状態を保存して shareUrl もスプシに記録させる想定
    toast(ok ? 'スプシから復元したよ' : '同期設定OK！この旅を保存するよ');
  } else {
    updateSyncUI('idle');
  }
}

/* ===================== Init ===================== */
window.addEventListener('load', async () => {
  // pid
  const pid = getPidFromUrl();
  if (pid) {
    state.projectId = pid;
  } else {
    state.projectId = generatePid();
    setPidToUrl(state.projectId);
  }

  // view tab
  state.viewTab = localStorage.getItem('warikan_view_tab') || 'card';

  // title input
  const titleInput = document.getElementById('projectTitle');
  if (titleInput) {
    titleInput.value = state.title || '';
    titleInput.addEventListener('input', (e) => {
      state.title = e.target.value;
      updateProjectNameUI();
      triggerAutoSync();
    });
  }

  // 初期UI
  updateProjectNameUI();
  renderTabs();      // タブの見た目反映
  updateSyncUI('idle');

  // GAS URL が設定済みならクラウドから復元を試す
  if (syncSettings.url) {
    const ok = await fetchFromCloud();
    render();
    toast(ok ? 'スプシから復元したよ' : '同期ON：この旅を保存するよ');
    triggerAutoSync(); // shareUrl / payload を記録
  } else {
    render();
  }
});

/* ===================== Tabs ===================== */
function setViewTab(tab) {
  state.viewTab = tab; // 'card' | 'table'
  localStorage.setItem('warikan_view_tab', tab);
  renderTabs();
}

function renderTabs() {
  const tabCard = document.getElementById('tabCard');
  const tabTable = document.getElementById('tabTable');
  const panelCard = document.getElementById('panelCard');
  const panelTable = document.getElementById('panelTable');

  const isCard = (state.viewTab || 'card') === 'card';

  if (tabCard) tabCard.className = tabBtnClass_(isCard);
  if (tabTable) tabTable.className = tabBtnClass_(!isCard);

  if (panelCard) panelCard.classList.toggle('hidden', !isCard);
  if (panelTable) panelTable.classList.toggle('hidden', isCard);
}

function tabBtnClass_(active) {
  return [
    'flex-1 py-2 rounded-2xl text-sm font-black transition-all',
    active ? 'bg-indigo-600 text-white shadow' : 'bg-slate-100 text-slate-600'
  ].join(' ');
}

/* ===================== Bottom Sheet (table row tap) ===================== */
let activeEditExpenseId = null;

function openExpenseSheet(expenseId) {
  activeEditExpenseId = expenseId;

  const overlay = document.getElementById('sheetOverlay');
  const sheet = document.getElementById('expenseSheet');
  if (!overlay || !sheet) return;

  renderExpenseSheet();

  overlay.classList.remove('hidden');
  sheet.classList.remove('translate-y-full');
  sheet.classList.add('translate-y-0');

  // overlay tap to close
  overlay.onclick = closeExpenseSheet;
}

function closeExpenseSheet() {
  const overlay = document.getElementById('sheetOverlay');
  const sheet = document.getElementById('expenseSheet');
  if (!overlay || !sheet) return;

  sheet.classList.remove('translate-y-0');
  sheet.classList.add('translate-y-full');

  // hide overlay after animation
  setTimeout(() => overlay.classList.add('hidden'), 180);

  activeEditExpenseId = null;
}

function renderExpenseSheet() {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;

  const titleEl = document.getElementById('sheetExpenseTitle');
  const amountEl = document.getElementById('sheetExpenseAmount');
  const payerEl = document.getElementById('sheetExpensePayer');
  const weightsEl = document.getElementById('sheetWeights');

  if (titleEl) titleEl.value = exp.title || '';
  if (amountEl) amountEl.value = exp.amount ?? '';

  if (payerEl) {
    payerEl.innerHTML = state.members
      .map(m => `<option value="${m.id}" ${m.id === exp.payerId ? 'selected' : ''}>${escapeHtml(m.name)}</option>`)
      .join('');
  }

  if (weightsEl) {
    weightsEl.innerHTML = state.members.map(m => {
      const w = Number(exp.weights?.[m.id] ?? 1);
      const isOn = w > 0;

      return `
        <div class="flex items-center justify-between bg-slate-50 border border-slate-200 rounded-2xl px-3 py-2">
          <div class="flex items-center gap-2 min-w-0">
            <div class="w-7 h-7 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[11px] font-black text-slate-600">
              ${escapeHtml(m.name.slice(0,1))}
            </div>
            <div class="font-bold truncate">${escapeHtml(m.name)}</div>
          </div>

          <div class="flex items-center gap-2">
            <button class="w-10 h-10 rounded-2xl font-black border transition-all ${
              isOn ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'
            }" onclick="sheetToggle01('${exp.id}','${m.id}')">
              ${isOn ? '1' : '0'}
            </button>

            <div class="flex items-center bg-white border border-slate-200 rounded-2xl overflow-hidden">
              <button class="w-10 h-10 text-slate-600 font-black hover:bg-slate-50"
                onclick="sheetStepWeight('${exp.id}','${m.id}',-0.1)">−</button>
              <input class="w-20 h-10 text-center font-black outline-none"
                inputmode="decimal"
                value="${String(w)}"
                onchange="sheetSetWeight('${exp.id}','${m.id}', this.value)" />
              <button class="w-10 h-10 text-slate-600 font-black hover:bg-slate-50"
                onclick="sheetStepWeight('${exp.id}','${m.id}',0.1)">＋</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  try { lucide.createIcons(); } catch(e) {}
}

/* ---- sheet field bindings ---- */
function sheetUpdateTitle(v) {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;
  exp.title = v;
  calculate();
  triggerAutoSync();
}

function sheetUpdateAmount(v) {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;
  exp.amount = parseFloat(v) || 0;
  calculate();
  triggerAutoSync();
}

function sheetUpdatePayer(v) {
  const exp = state.expenses.find(e => e.id === activeEditExpenseId);
  if (!exp) return;
  exp.payerId = v;
  calculate();
  triggerAutoSync();
}

function sheetToggle01(eid, mid) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;
  const cur = Number(exp.weights?.[mid] ?? 0);
  exp.weights[mid] = cur > 0 ? 0 : 1;
  calculate();
  renderExpenseSheet();
  triggerAutoSync();
}

function sheetSetWeight(eid, mid, val) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;
  let n = Number(val);
  if (!Number.isFinite(n)) n = 0;
  if (n < 0) n = 0;
  exp.weights[mid] = n;
  calculate();
  renderExpenseSheet();
  triggerAutoSync();
}

function sheetStepWeight(eid, mid, delta) {
  const exp = state.expenses.find(e => e.id === eid);
  if (!exp) return;
  const cur = Number(exp.weights?.[mid] ?? 0);
  let next = Math.round((cur + delta) * 10) / 10;
  if (next < 0) next = 0;
  exp.weights[mid] = next;
  calculate();
  renderExpenseSheet();
  triggerAutoSync();
}

/* ===================== Share URL ===================== */
function copyShareLink() {
  const url = new URL(window.location.href);
  url.searchParams.set('pid', state.projectId);

  const text = url.toString();
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => toast('URLをコピーしたよ！'))
      .catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  toast('URLをコピーしたよ！');
}

/* ===================== Toast ===================== */
let toastTimer = null;
function toast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.innerText = msg;

  t.classList.remove('opacity-0', 'translate-y-2', 'pointer-events-none');
  t.classList.add('opacity-100', 'translate-y-0');

  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    t.classList.remove('opacity-100', 'translate-y-0');
    t.classList.add('opacity-0', 'translate-y-2', 'pointer-events-none');
  }, 1600);
}

/* ===================== Small helpers (safe) ===================== */
function updateProjectNameUI() {
  const el = document.getElementById('currentProjectName');
  if (el) el.innerText = state.title || '（未設定）';
}

/* ===================== END ===================== */
